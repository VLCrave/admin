<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Login</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-black min-h-screen flex items-center justify-center px-4">
  <div class="bg-gray-800/80 backdrop-blur-lg p-8 rounded-2xl shadow-2xl w-full max-w-sm">
    <h2 class="text-3xl font-bold text-center text-white mb-6">Admin Login</h2>
    <form onsubmit="loginAdmin(event)" class="space-y-5">
      <div>
        <label class="block text-gray-300 mb-2 font-medium">Email</label>
        <input type="email" id="email" class="w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="admin@email.com" required>
      </div>
      <div>
        <label class="block text-gray-300 mb-2 font-medium">Password</label>
        <input type="password" id="password" class="w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••••" required>
      </div>
      <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold transition transform hover:scale-105">
        Login
      </button>
    </form>
    <p class="text-gray-400 text-sm text-center mt-4">
      <a href="#" onclick="forgotPassword()" class="text-blue-400 hover:underline">Lupa Password?</a>
    </p>
    <p class="text-gray-400 text-sm text-center mt-6">© 2025 Crave Street Admin Panel</p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAzzr0ChjdVi7m4Ge-EFm3OK43ASujjZ40",
      authDomain: "crave-street-id.firebaseapp.com",
      projectId: "crave-street-id",
      storageBucket: "crave-street-id.firebasestorage.app",
      messagingSenderId: "221955592583",
      appId: "1:221955592583:web:43dc59d791e750095cc322",
      measurementId: "G-WCRQGLW47B"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
window.loginAdmin = async function(event) {
  event.preventDefault();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();

  try {
    // Login via Firebase Auth
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;

    // Ambil data admin dari Firestore
    const q = query(collection(db, "admins"), where("email", "==", email));
    const querySnapshot = await getDocs(q);

    let adminData;
    if (querySnapshot.empty) {
      // Jika belum ada nama, minta input nama
      const { value: nama } = await Swal.fire({
        title: "Masukkan Nama Anda",
        input: "text",
        inputPlaceholder: "Nama lengkap",
        allowOutsideClick: false,
        inputValidator: value => !value && 'Nama wajib diisi'
      });

      // Simpan ke Firestore
      const docRef = await addDoc(collection(db, "admins"), { email, nama, createdAt: serverTimestamp() });
      adminData = { id: docRef.id, nama, email };

    } else {
      querySnapshot.forEach(doc => {
        adminData = { id: doc.id, ...doc.data() };
      });
    }

    // Simpan session
    sessionStorage.setItem("currentAdmin", JSON.stringify(adminData));

    // --- Simpan log admin login ---
    if (adminData.id) {
      await addDoc(collection(db, "admin_logs"), {
        adminId: adminData.id,
        aksi: "Login ke dashboard",
        keterangan: "Login berhasil",
        createdAt: serverTimestamp()
      });
    }

    Swal.fire({
      icon: "success",
      title: "Login Berhasil",
      text: "Selamat datang " + adminData.nama,
      confirmButtonColor: "#2563eb"
    }).then(() => window.location.href = "index.html");

  } catch (err) {
    if(err.code === "auth/wrong-password" || err.code === "auth/invalid-credential") {
      Swal.fire({
        icon: "error",
        title: "Password Salah",
        text: "Silakan periksa kembali password Anda",
        confirmButtonText: "Kirim email reset",
        showCancelButton: true,
        cancelButtonText: "Batal",
        confirmButtonColor: "#2563eb",
        cancelButtonColor: "#ef4444"
      }).then(result => {
        if(result.isConfirmed) forgotPassword();
      });
    } else if(err.code === "auth/user-not-found") {
      Swal.fire({
        icon: "error",
        title: "Email Tidak Terdaftar",
        text: "Email yang Anda masukkan belum terdaftar sebagai admin",
        confirmButtonColor: "#ef4444"
      });
    } else if(err.code === "auth/invalid-email") {
      Swal.fire({
        icon: "error",
        title: "Email Tidak Valid",
        text: "Format email yang Anda masukkan tidak valid",
        confirmButtonColor: "#ef4444"
      });
    } else {
      Swal.fire({
        icon: "error",
        title: "Login Gagal",
        text: err.message,
        confirmButtonColor: "#ef4444"
      });
    }
  }
}

    window.forgotPassword = async function() {
      const { value: email } = await Swal.fire({
        title: "Lupa Password",
        input: "email",
        inputLabel: "Masukkan email Anda",
        inputPlaceholder: "admin@email.com",
        inputValidator: value => !value && 'Email wajib diisi'
      });

      if(email) {
        sendPasswordResetEmail(auth, email)
          .then(() => {
            Swal.fire({
              icon: "success",
              title: "Email Terkirim",
              text: "Cek email Anda untuk reset password",
              confirmButtonColor: "#2563eb"
            });
          })
          .catch(err => {
            Swal.fire({
              icon: "error",
              title: "Gagal Mengirim Email",
              text: err.message,
              confirmButtonColor: "#ef4444"
            });
          });
      }
    }
  </script>
</body>
</html>
