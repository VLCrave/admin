<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dashboard - Crave Street Admin</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* sedikit tweak agar mobile lebih rapih */
  .list-item { background: rgba(55,65,81,0.5); border-radius: 12px; padding: 12px; }
  .small-txt { font-size: 12px; color: #c7c7c7; }
</style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-black min-h-screen text-white">

<!-- HEADER -->
<header class="sticky top-0 bg-gray-800/90 backdrop-blur-lg z-50 px-4 py-3 flex flex-wrap items-center justify-between shadow-lg">
  <div class="flex items-center gap-2 flex-1">
    <img src="https://vlcrave.github.io/admin/logo.png" alt="Logo" class="h-8 w-8 rounded-full">
    <h1 class="text-white font-bold text-lg truncate">Crave Street</h1>
  </div>
  <div class="flex items-center gap-3">
    <div class="text-right mr-2">
      <p class="text-gray-300 text-xs">Halo, <span id="userName" class="font-semibold text-blue-400">Admin</span></p>
      <p class="text-gray-400 text-[10px]">Saldo: <span id="saldo" class="font-semibold text-green-400">Rp 0</span></p>
      <p class="text-gray-400 text-[10px]">Role: <span id="userRole" class="font-semibold text-yellow-400">Admin</span></p>
    </div>
    <img id="userPhoto" src="https://vlcrave.github.io/admin/logo.png" alt="User Photo" class="h-8 w-8 rounded-full border-2 border-blue-400">
    <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded-lg font-semibold text-white text-xs">Logout</button>
  </div>
</header>

<!-- MAIN -->
<main class="p-4 max-w-md mx-auto mt-6">

  <!-- Dashboard Grid (mobile single-column) -->
  <div id="dashboardGrid" class="space-y-4">
    <!-- cards will be injected here -->
  </div>

  <!-- KAS (hidden until clicked) -->
  <div id="kasContainer" class="hidden mt-6 text-white">
    <button onclick="backToDashboard()" class="mb-3 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded-lg">‚Üê Kembali ke Dashboard</button>
    <h2 class="text-xl font-bold mb-2">üìä Laporan Arus Kas</h2>
    <div class="mb-3 flex gap-2 flex-wrap">
      <button onclick="filterKas('all')" class="bg-gray-700 px-3 py-1 rounded-lg">Semua</button>
      <button onclick="filterKas('mingguan')" class="bg-gray-700 px-3 py-1 rounded-lg">Mingguan</button>
      <button onclick="filterKas('bulanan')" class="bg-gray-700 px-3 py-1 rounded-lg">Bulanan</button>
    </div>
    <canvas id="chartKas" class="mb-3 bg-gray-800 rounded-xl p-2"></canvas>
    <div id="kasList" class="space-y-2 max-h-96 overflow-y-auto"></div>
  </div>

  <!-- TRANSAKSI -->
  <div id="transaksiContainer" class="hidden mt-6 text-white">
    <button onclick="backToDashboard()" class="mb-3 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded-lg">‚Üê Kembali ke Dashboard</button>
    <h2 class="text-xl font-bold mb-2">üõí Data Transaksi</h2>
    <div class="mb-3 flex gap-2 flex-wrap">
      <button onclick="filterTransaksi('all')" class="bg-gray-700 px-3 py-1 rounded-lg">Semua</button>
      <button onclick="filterTransaksi('harian')" class="bg-gray-700 px-3 py-1 rounded-lg">Harian</button>
      <button onclick="filterTransaksi('mingguan')" class="bg-gray-700 px-3 py-1 rounded-lg">Mingguan</button>
      <button onclick="filterTransaksi('bulanan')" class="bg-gray-700 px-3 py-1 rounded-lg">Bulanan</button>
    </div>
    <div id="transaksiTotal" class="mb-3"></div>
    <div id="transaksiList" class="space-y-2 max-h-96 overflow-y-auto"></div>
  </div>

  <!-- VOUCHER -->
  <div id="voucherContainer" class="hidden mt-6 text-white">
    <button onclick="backToDashboard()" class="mb-3 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded-lg">‚Üê Kembali ke Dashboard</button>
    <h2 class="text-xl font-bold mb-3">üéüÔ∏è Kelola Voucher</h2>

    <!-- Generate -->
    <div class="bg-gray-800/60 p-4 rounded-xl mb-3">
      <label class="block text-sm font-semibold mb-2">Jumlah Generate (1 - 100)</label>
      <input id="voucherJumlah" type="number" min="1" max="100" placeholder="Masukkan jumlah" class="w-full px-3 py-2 rounded-lg bg-gray-700 text-white mb-3 focus:outline-none">
      <div class="flex gap-2">
        <button id="genBtn" onclick="generateVouchers()" class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-lg font-semibold">‚ûï Generate</button>
        <button onclick="loadVouchers()" class="bg-gray-600 hover:bg-gray-700 px-3 py-2 rounded-lg">üîÑ Refresh</button>
      </div>
      <p class="small-txt mt-2">Kode disimpan di collection <code>redeem_codes</code>. Format: <strong>CRVSxxxxxx</strong></p>
    </div>

    <!-- Filter list -->
    <div class="mb-2 flex gap-2">
      <button onclick="renderVouchers('all')" class="bg-gray-700 px-3 py-1 rounded-lg">Semua</button>
      <button onclick="renderVouchers('unused')" class="bg-gray-700 px-3 py-1 rounded-lg">Belum Dipakai</button>
      <button onclick="renderVouchers('used')" class="bg-gray-700 px-3 py-1 rounded-lg">Sudah Dipakai</button>
    </div>

    <!-- List -->
    <div id="voucherList" class="space-y-3 max-h-96 overflow-y-auto pb-6"></div>
  </div>

</main>

<!-- FIREBASE + LOGIC -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
  import {
    getFirestore, collection, getDocs, addDoc, serverTimestamp,
    query, orderBy, doc, updateDoc, deleteDoc, getDoc
  } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

  // ===== FIREBASE CONFIG =====
  const firebaseConfig = {
    apiKey: "AIzaSyAzzr0ChjdVi7m4Ge-EFm3OK43ASujjZ40",
    authDomain: "crave-street-id.firebaseapp.com",
    projectId: "crave-street-id",
    storageBucket: "crave-street-id.firebasestorage.app",
    messagingSenderId: "221955592583",
    appId: "1:221955592583:web:43dc59d791e750095cc322",
    measurementId: "G-WCRQGLW47B"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let kasData = [];
  let existingVoucherCodes = []; // cache for uniqueness
  const voucherListEl = document.getElementById("voucherList");
  const voucherContainer = document.getElementById("voucherContainer");
  const kasContainer = document.getElementById("kasContainer");
  const transaksiContainer = document.getElementById("transaksiContainer");

  // ===== AUTH CHECK =====
  onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = "login.html";
    currentUser = user;

    // load user info if exists
    try {
      const userDocRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(userDocRef);
      const data = userSnap.exists() ? userSnap.data() : {};
      document.getElementById("userName").innerText = data.name || (user.displayName || "Admin");
      document.getElementById("userRole").innerText = data.role || "Admin";
    } catch (e) {
      console.warn("Tidak dapat membaca data user:", e);
    }

    updateSaldo();
    renderDashboard();
    await loadKas();
    await loadVouchers(); // preload voucher cache
  });

  // ===== LOGOUT =====
  window.logout = () => signOut(auth).then(()=>window.location.href="login.html");

  // ===== UPDATE SALDO =====
  async function updateSaldo(){
    const snap = await getDocs(collection(db,"transaksi"));
    let pemasukan=0, pengeluaran=0;
    snap.forEach(d=>{
      const t=d.data();
      if(t.type=="penjualan") pemasukan+=t.total || 0;
      else pengeluaran+=t.total || 0;
    });
    document.getElementById("saldo").innerText="Rp "+(pemasukan-pengeluaran).toLocaleString("id-ID");
  }

  // ===== DASHBOARD RENDER =====
  function renderDashboard(){
    kasContainer.classList.add("hidden");
    transaksiContainer.classList.add("hidden");
    voucherContainer.classList.add("hidden");

    const grid = document.getElementById("dashboardGrid");
    grid.innerHTML = "";

    const modules = [
      {key:"kas", title:"üìä Laporan Arus Kas", desc:"Pantau arus kas otomatis."},
      {key:"transaksi", title:"üõí Data Transaksi", desc:"Kelola data transaksi."},
      {key:"voucher", title:"üéüÔ∏è Kelola Voucher", desc:"Generate & kelola voucher redeem."}
    ];

    modules.forEach(mod=>{
      const card = document.createElement("div");
      card.className = "list-item flex flex-col gap-2";
      card.innerHTML = `
        <div class="flex justify-between items-start">
          <div>
            <h3 class="font-semibold">${mod.title}</h3>
            <p class="text-sm text-gray-300">${mod.desc}</p>
          </div>
        </div>
        <div class="flex gap-2">
          <button onclick="showSection('${mod.key}')" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded-lg font-semibold">Lihat Detail</button>
          ${mod.key !== 'kas' ? `<button onclick="tambah('${mod.key}')" class="bg-green-600 hover:bg-green-700 py-2 px-3 rounded-lg">Tambah</button>` : ''}
        </div>
      `;
      grid.appendChild(card);
    });
  }

  // ===== NAVIGATION =====
  window.showSection = function(key){
    document.getElementById("dashboardGrid").scrollIntoView({behavior:"smooth"});
    if(key === "kas"){
      kasContainer.classList.remove("hidden");
      transaksiContainer.classList.add("hidden");
      voucherContainer.classList.add("hidden");
      document.getElementById("dashboardGrid").classList.add("hidden");
      renderKasList("all");
    } else if(key === "transaksi"){
      transaksiContainer.classList.remove("hidden");
      kasContainer.classList.add("hidden");
      voucherContainer.classList.add("hidden");
      document.getElementById("dashboardGrid").classList.add("hidden");
      renderTransaksi("all");
    } else if(key === "voucher"){
      voucherContainer.classList.remove("hidden");
      kasContainer.classList.add("hidden");
      transaksiContainer.classList.add("hidden");
      document.getElementById("dashboardGrid").classList.add("hidden");
      renderVouchers("all");
    } else {
      Swal.fire("Info","Fitur "+key,"info");
    }
  };

  window.backToDashboard = function(){
    kasContainer.classList.add("hidden");
    transaksiContainer.classList.add("hidden");
    voucherContainer.classList.add("hidden");
    document.getElementById("dashboardGrid").classList.remove("hidden");
  };

  // ===== KAS / TRANSAKSI (tetap seperti sebelumnya) =====
  async function loadKas(){
    kasData = [];
    const snap = await getDocs(query(collection(db,"transaksi"), orderBy("tanggal","asc")));
    snap.forEach(d=>{
      const t = d.data();
      kasData.push({...t, id: d.id});
    });
  }

  window.filterKas = function(type){ renderKasList(type); }

  function renderKasList(type){
    const kasList = document.getElementById("kasList");
    kasList.innerHTML = "";
    const now = new Date();
    const grouped = {};
    kasData.forEach(t=>{
      let include = true;
      const tDate = t.tanggal ? new Date(t.tanggal.seconds * 1000) : null;
      if(type === "mingguan"){
        if(!tDate) include = false;
        else {
          const diff = (now.getTime() - tDate.getTime()) / (1000*60*60*24);
          if(diff > 7) include = false;
        }
      } else if(type === "bulanan"){
        if(!tDate) include = false;
        else if(tDate.getMonth() !== now.getMonth() || tDate.getFullYear() !== now.getFullYear()) include = false;
      }
      if(include){
        const dayKey = tDate ? `${tDate.getDate().toString().padStart(2,"0")}/${(tDate.getMonth()+1).toString().padStart(2,"0")}/${tDate.getFullYear()}` : "-";
        if(!grouped[dayKey]) grouped[dayKey] = [];
        grouped[dayKey].push(t);
      }
    });

    Object.keys(grouped).forEach(day=>{
      const list = grouped[day];
      let pemasukan = 0, pengeluaran = 0;
      list.forEach(it=>{
        if(it.type === "penjualan") pemasukan += it.total || 0;
        else pengeluaran += it.total || 0;
      });
      const laba = pemasukan - pengeluaran;
      kasList.innerHTML += `
        <div class="border-b border-gray-600 py-2">
          <p class="font-semibold">Tanggal: ${day}</p>
          <p>Jumlah Transaksi: ${list.length}</p>
          <p class="text-green-400">Pemasukan: Rp ${pemasukan.toLocaleString("id-ID")}</p>
          <p class="text-red-400">Pengeluaran: Rp ${pengeluaran.toLocaleString("id-ID")}</p>
          <p class="font-semibold text-white">Laba Kotor: Rp ${laba.toLocaleString("id-ID")}</p>
        </div>
      `;
    });

    // Chart update
    const labels = [], pemasukan = [], pengeluaran = [];
    Object.keys(grouped).forEach(day=>{
      let p=0, q=0;
      grouped[day].forEach(it=> { if(it.type==="penjualan") p+=it.total||0; else q+=it.total||0; });
      labels.push(day); pemasukan.push(p); pengeluaran.push(q);
    });
    const ctx = document.getElementById("chartKas").getContext("2d");
    if(window.kasChart) window.kasChart.destroy();
    window.kasChart = new Chart(ctx, {
      type: "bar",
      data: { labels, datasets: [
        { label: "Pemasukan", data: pemasukan, backgroundColor: "rgba(34,197,94,0.7)" },
        { label: "Pengeluaran", data: pengeluaran, backgroundColor: "rgba(239,68,68,0.7)" }
      ]},
      options: { responsive:true, plugins:{legend:{labels:{color:"white"}}}, scales:{x:{ticks:{color:"white"}}, y:{ticks:{color:"white"}}} }
    });
  }

  // ===== TRANSAKSI RENDER =====
  window.filterTransaksi = function(type){ renderTransaksi(type); }

  async function renderTransaksi(type="all"){
    const transaksiDiv = document.getElementById("transaksiList");
    const transaksiTotal = document.getElementById("transaksiTotal");
    transaksiDiv.innerHTML = "";
    let totalPemasukan = 0, totalPengeluaran = 0;
    const snap = await getDocs(query(collection(db,"transaksi"), orderBy("tanggal","asc")));
    const now = new Date();

    snap.forEach(d=>{
      const t = d.data();
      let include = true;
      if(t.tanggal){
        const tDate = new Date(t.tanggal.seconds*1000);
        if(type==="harian") include = tDate.toDateString() === now.toDateString();
        else if(type==="mingguan"){ include = (now.getTime()-tDate.getTime())/(1000*60*60*24) <= 7; }
        else if(type==="bulanan"){ include = tDate.getMonth() === now.getMonth() && tDate.getFullYear() === now.getFullYear(); }
      }
      if(include){
        if(t.type==="penjualan") totalPemasukan += t.total || 0;
        else totalPengeluaran += t.total || 0;
        const dt = t.tanggal ? new Date(t.tanggal.seconds*1000) : null;
        const tDateStr = dt ? `${dt.getDate().toString().padStart(2,"0")}/${(dt.getMonth()+1).toString().padStart(2,"0")}/${dt.getFullYear()}, ${dt.getHours().toString().padStart(2,"0")}.${dt.getMinutes().toString().padStart(2,"0")}` : "-";
        transaksiDiv.innerHTML += `
          <div class="border-b border-gray-600 py-2">
            <p>Jenis: ${t.type}</p>
            ${t.produkNama ? `<p>Produk: ${t.produkNama}</p>` : ""}
            <p>Total: Rp ${ (t.total || 0).toLocaleString("id-ID") }</p>
            <p class="small-txt">Tanggal: ${tDateStr}</p>
            <p class="small-txt italic">Ditambahkan oleh: ${t.adminName || "Admin"}</p>
          </div>
        `;
      }
    });

    transaksiTotal.innerHTML = `
      <p class="font-semibold text-green-400">Total Pemasukan: Rp ${totalPemasukan.toLocaleString("id-ID")}</p>
      <p class="font-semibold text-red-400">Total Pengeluaran: Rp ${totalPengeluaran.toLocaleString("id-ID")}</p>
      <p class="font-semibold text-white">Saldo: Rp ${(totalPemasukan-totalPengeluaran).toLocaleString("id-ID")}</p>
    `;
  }

  // ===== TAMBAH (fungsi reuse untuk transaksi/voucher jika perlu) =====
  window.tambah = async (section) => {
    if(section !== "transaksi" && section !== "voucher") {
      Swal.fire("Info","Fitur tambah untuk "+section+" belum tersedia.","info");
      return;
    }

    if(section === "transaksi"){
      // logic transaksi (tetap sama seperti sebelumnya)
      // ... jika perlu, bisa panggil fungsi tambah transaksi di sini
      Swal.fire("Info","Gunakan tombol Tambah di panel Transaksi.", "info");
      return;
    }

    if(section === "voucher"){
      // open modal untuk generate singkat 1 voucher
      const { value: jumlah } = await Swal.fire({
        title: 'Generate Voucher',
        input: 'number',
        inputLabel: 'Jumlah (1-100)',
        inputAttributes: { min: 1, max: 100, step: 1 },
        inputValue: 1,
        showCancelButton: true
      });
      if(!jumlah) return;
      document.getElementById("voucherJumlah").value = jumlah;
      generateVouchers();
    }
  };

  // ===== VOUCHER: LOAD CACHE =====
  async function loadVouchers(){
    existingVoucherCodes = [];
    // get all codes only for cache & list (ordered newest first)
    const snap = await getDocs(query(collection(db, "redeem_codes"), orderBy("createdAt", "desc")));
    const arr = [];
    snap.forEach(d=>{
      const data = d.data();
      arr.push({ id: d.id, ...data });
      if(data && data.code) existingVoucherCodes.push(data.code);
    });
    // If currently on voucher view, render
    if(!voucherContainer.classList.contains("hidden")){
      // render with current filter (default all)
      renderVouchers("all", arr);
    }
    return arr;
  }

  // ===== GENERATE VOUCHERS =====
  async function generateVouchers(){
    const input = document.getElementById("voucherJumlah");
    let jumlah = parseInt(input.value);
    if(!jumlah || jumlah < 1 || jumlah > 100) {
      Swal.fire("Error","Masukkan jumlah valid antara 1 sampai 100.","error");
      return;
    }
    const btn = document.getElementById("genBtn");
    btn.disabled = true;
    btn.innerText = "Generating...";
    try {
      // refresh existing cache
      await loadVouchers();

      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      const created = [];
      for(let i=0;i<jumlah;i++){
        let code;
        let attempts = 0;
        do {
          code = "CRVS" + Array.from({length:6}, ()=>chars[Math.floor(Math.random()*chars.length)]).join('');
          attempts++;
          if(attempts > 200) throw new Error("Gagal membuat kode unik, coba ulang.");
        } while(existingVoucherCodes.includes(code));
        const docRef = await addDoc(collection(db, "redeem_codes"), {
          code,
          used: false,
          usedBy: null,
          usedAt: null,
          createdAt: serverTimestamp(),
          createdBy: currentUser.uid || null
        });
        existingVoucherCodes.push(code);
        created.push({ id: docRef.id, code });
      }
      input.value = "";
      Swal.fire("Berhasil", `Generated ${created.length} voucher.`, "success");
      await loadVouchers();
      renderVouchers("all");
    } catch (err) {
      console.error("generate error", err);
      Swal.fire("Error", err.message || "Gagal generate voucher", "error");
    } finally {
      btn.disabled = false;
      btn.innerText = "‚ûï Generate";
    }
  }

  // ===== RENDER VOUCHERS (filter: all | used | unused) =====
  // optional param preloadedArr: to avoid re-fetch if already loaded
  async function renderVouchers(filter="all", preloadedArr=null){
    voucherListEl.innerHTML = "";
    let arr = preloadedArr;
    if(!arr) {
      arr = await loadVouchers(); // returns array
    }

    if(filter === "unused") arr = arr.filter(x => !x.used);
    if(filter === "used") arr = arr.filter(x => x.used);

    if(arr.length === 0){
      voucherListEl.innerHTML = `<p class="text-center text-gray-400">Tidak ada voucher.</p>`;
      return;
    }

    arr.forEach(v => {
      const usedTxt = v.used ? `<span class="text-sm text-yellow-300 font-semibold">Dipakai</span>` : `<span class="text-sm text-green-300 font-semibold">Belum digunakan</span>`;
      const usedBy = v.usedBy ? `<div class="small-txt">Digunakan oleh: ${escapeHtml(v.usedBy)}</div>` : '';
      const usedAt = v.usedAt ? `<div class="small-txt">Waktu: ${formatTimestamp(v.usedAt)}</div>` : '';
      voucherListEl.innerHTML += `
        <div class="list-item flex flex-col gap-2" id="v-${v.id}">
          <div class="flex justify-between items-start">
            <div>
              <div class="font-mono font-semibold text-lg">${v.code}</div>
              ${usedTxt}
            </div>
            <div class="flex flex-col items-end gap-2">
              <button onclick="promptToggleUsed('${v.id}', ${v.used ? 'true' : 'false'})" class="px-3 py-1 rounded-lg text-xs ${v.used ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-blue-600 hover:bg-blue-700'}">
                ${v.used ? 'Reset Unused' : 'Mark Used'}
              </button>
              <button onclick="deleteVoucher('${v.id}', '${v.code}')" class="mt-1 px-3 py-1 rounded-lg text-xs bg-red-600 hover:bg-red-700">Hapus</button>
            </div>
          </div>
          ${usedBy}
          ${usedAt}
          <div class="small-txt">Dibuat: ${v.createdAt ? formatTimestamp(v.createdAt) : '-'}</div>
        </div>
      `;
    });
  }

  // ===== PROMPT & TOGGLE USED =====
  window.promptToggleUsed = async (docId, currentlyUsed) => {
    if(!currentlyUsed){
      // mark as used -> minta input usedBy (email/uid)
      const { value: usedBy } = await Swal.fire({
        title: 'Tandai sebagai Dipakai',
        input: 'text',
        inputLabel: 'Masukkan email/UID user yang memakai (atau biarkan kosong untuk current user)',
        inputPlaceholder: 'user@example.com atau uid',
        showCancelButton: true
      });
      if(usedBy === undefined) return;
      const usedByFinal = usedBy && usedBy.trim().length ? usedBy.trim() : (currentUser.email || currentUser.uid || "admin");
      await setVoucherUsed(docId, usedByFinal);
    } else {
      // reset to unused
      const res = await Swal.fire({
        title: 'Reset jadi Belum Dipakai?',
        text: 'Voucher akan di-set unused (menghapus usedBy & usedAt).',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Reset'
      });
      if(!res.isConfirmed) return;
      await resetVoucherUnused(docId);
    }
  };

  async function setVoucherUsed(docId, usedBy){
    try {
      await updateDoc(doc(db, "redeem_codes", docId), {
        used: true,
        usedBy: usedBy,
        usedAt: serverTimestamp()
      });
      Swal.fire("Berhasil", "Voucher ditandai sudah digunakan.", "success");
      await loadVouchers();
      renderVouchers("all");
    } catch (err) {
      console.error("set used error", err);
      Swal.fire("Error", "Gagal menandai voucher: " + (err.message||""), "error");
    }
  }

  async function resetVoucherUnused(docId){
    try {
      await updateDoc(doc(db, "redeem_codes", docId), {
        used: false,
        usedBy: null,
        usedAt: null
      });
      Swal.fire("Berhasil", "Voucher direset ke unused.", "success");
      await loadVouchers();
      renderVouchers("all");
    } catch (err) {
      console.error("reset error", err);
      Swal.fire("Error", "Gagal reset voucher: " + (err.message||""), "error");
    }
  }

  // ===== DELETE VOUCHER =====
  async function deleteVoucher(docId, code){
    const res = await Swal.fire({
      title: `Hapus ${code}?`,
      text: "Voucher akan dihapus permanen.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Hapus"
    });
    if(!res.isConfirmed) return;
    try {
      await deleteDoc(doc(db, "redeem_codes", docId));
      Swal.fire("Dihapus", "Voucher berhasil dihapus.", "success");
      // remove from UI quickly
      const el = document.getElementById("v-"+docId);
      if(el) el.remove();
      // reload cache
      await loadVouchers();
    } catch (err) {
      console.error("delete error", err);
      Swal.fire("Error", "Gagal hapus voucher: " + (err.message||""), "error");
    }
  }

  // ===== UTIL =====
  function formatTimestamp(ts){
    // ts can be Firestore Timestamp object or JS date string
    try {
      if(!ts) return "-";
      if(ts.seconds !== undefined){ // Firestore Timestamp
        const d = new Date(ts.seconds * 1000);
        return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,"0")}-${d.getDate().toString().padStart(2,"0")} ${d.getHours().toString().padStart(2,"0")}:${d.getMinutes().toString().padStart(2,"0")}`;
      } else {
        const d = new Date(ts);
        return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,"0")}-${d.getDate().toString().padStart(2,"0")} ${d.getHours().toString().padStart(2,"0")}:${d.getMinutes().toString().padStart(2,"0")}`;
      }
    } catch(e){
      return "-";
    }
  }

  function escapeHtml(s){
    if(!s) return "";
    return String(s).replace(/[&<>"'`=\/]/g, function (ch) { return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[ch]; });
  }

  // initial preload
  // loadVouchers(); // already called after auth

</script>
</body>
</html>
