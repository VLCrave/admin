<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Crave Street Admin</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
  .list-item { background: rgba(55,65,81,0.5); border-radius: 12px; padding: 12px; }
  .small-txt { font-size: 12px; color: #c7c7c7; }
  @media print {
    body * { visibility: hidden; }
    #printArea, #printArea * { visibility: visible; }
    #printArea { position: absolute; top:0; left:0; width:100%; }
  }
</style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-black min-h-screen text-white">

<!-- HEADER -->
<header class="sticky top-0 bg-gray-800/90 backdrop-blur-lg z-50 px-4 py-3 flex flex-wrap items-center justify-between shadow-lg">
  <div class="flex items-center gap-2 flex-1">
    <img src="https://vlcrave.github.io/admin/logo.png" alt="Logo" class="h-8 w-8 rounded-full">
    <h1 class="text-white font-bold text-lg truncate">Crave Street Admin</h1>
  </div>
  <div class="flex items-center gap-3">
    <div class="text-right mr-2">
      <p class="text-gray-300 text-xs">Halo, <span id="userName" class="font-semibold text-blue-400">Admin</span></p>
      <p class="text-gray-400 text-[10px]">Role: <span class="font-semibold text-yellow-400">Admin</span></p>
    </div>
    <img id="userPhoto" src="https://vlcrave.github.io/admin/logo.png" alt="User" class="h-8 w-8 rounded-full border-2 border-blue-400">
    <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded-lg font-semibold text-white text-xs">Logout</button>
  </div>
</header>

<!-- MAIN -->
<main class="p-4 max-w-5xl mx-auto mt-6">
  <div id="dashboardGrid" class="space-y-4"></div>

  <!-- 📢 LOG / ANNOUNCEMENT BOARD -->
  <div id="announcementBoard" class="hidden mt-4 bg-gray-800/50 border border-gray-700 rounded-xl p-4">
    <h3 class="text-lg font-semibold mb-2">📢 Papan Pengumuman</h3>
    <ul id="announcementList" class="text-sm text-gray-300 list-disc list-inside"></ul>
  </div>

  <!-- 🎟️ VOUCHER SECTION -->
  <div id="voucherContainer" class="hidden mt-6 text-white">
    <button onclick="backToDashboard()" class="mb-3 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded-lg">← Kembali</button>
    <h2 class="text-xl font-bold mb-3">🎟️ Kelola Voucher</h2>

    <div class="bg-gray-800/60 p-4 rounded-xl mb-3">
      <label class="block text-sm font-semibold mb-2">Jumlah Generate (1 - 100)</label>
      <input id="voucherJumlah" type="number" min="1" max="100" placeholder="Masukkan jumlah" class="w-full px-3 py-2 rounded-lg bg-gray-700 text-white mb-3 focus:outline-none">
      <div class="flex gap-2">
        <button id="genBtn" onclick="generateVouchers()" class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-lg font-semibold">➕ Generate</button>
        <button onclick="loadVouchers()" class="bg-gray-600 hover:bg-gray-700 px-3 py-2 rounded-lg">🔄 Refresh</button>
        <button onclick="printAllVouchers()" class="bg-purple-600 hover:bg-purple-700 px-3 py-2 rounded-lg">🖨️ Print Semua</button>
      </div>
    </div>

    <div class="mb-2 flex gap-2">
      <button onclick="renderVouchers('all')" class="bg-gray-700 px-3 py-1 rounded-lg">Semua</button>
      <button onclick="renderVouchers('unused')" class="bg-gray-700 px-3 py-1 rounded-lg">Belum Dipakai</button>
      <button onclick="renderVouchers('used')" class="bg-gray-700 px-3 py-1 rounded-lg">Sudah Dipakai</button>
    </div>

    <div id="voucherList" class="space-y-3 max-h-96 overflow-y-auto pb-6"></div>
  </div>

  <!-- 💰 FINANCE SECTION -->
  <div id="financeContainer" class="hidden mt-6 text-white">
    <button onclick="backToDashboard()" class="mb-3 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded-lg">← Kembali</button>
    <h2 class="text-xl font-bold mb-3">📊 Laporan Keuangan</h2>

    <!-- Filter -->
    <div class="flex flex-wrap gap-2 mb-3">
      <button onclick="filterFinance('today')" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded">Hari Ini</button>
      <button onclick="filterFinance('7')" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded">7 Hari</button>
      <button onclick="filterFinance('30')" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded">30 Hari</button>
      <button onclick="filterFinance('all')" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded">Semua</button>
    </div>

    <div class="bg-gray-800/60 p-4 rounded-xl mb-4">
      <h3 class="font-semibold mb-2">Tambah Transaksi</h3>
      <div class="grid grid-cols-2 gap-2">
        <select id="jenisTransaksi" class="bg-gray-700 rounded-lg p-2">
          <option value="pemasukan">Pemasukan</option>
          <option value="pengeluaran">Pengeluaran</option>
        </select>
        <input id="nominalTransaksi" type="number" placeholder="Nominal (Rp)" class="bg-gray-700 rounded-lg p-2">
      </div>
      <input id="keteranganTransaksi" type="text" placeholder="Keterangan" class="bg-gray-700 rounded-lg p-2 w-full mt-2">
      <button onclick="tambahTransaksi()" class="mt-3 bg-green-600 hover:bg-green-700 px-3 py-2 rounded-lg w-full font-semibold">➕ Simpan Transaksi</button>
    </div>

    <div id="financeSummary" class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4"></div>
    <div id="financeList" class="space-y-3 max-h-96 overflow-y-auto"></div>
  </div>
</main>

<script type="module">
// ====== FIREBASE SETUP ======
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, orderBy, serverTimestamp, updateDoc, deleteDoc, doc, query } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyAzzr0ChjdVi7m4Ge-EFm3OK43ASujjZ40",
  authDomain: "crave-street-id.firebaseapp.com",
  projectId: "crave-street-id",
});
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let existingVouchers = [];
let financeData = [];

// ====== LOGIN CHECK ======
onAuthStateChanged(auth, async (user)=>{
  if(!user) return location.href="login.html";
  currentUser = user;
  document.getElementById("userName").innerText = user.displayName || "Admin";
  renderDashboard();
  await loadVouchers();
  await loadFinance();
  loadAnnouncements();
});
window.logout=()=>signOut(auth).then(()=>location.href="login.html");

// ===== DASHBOARD =====
function renderDashboard(){
  const grid=document.getElementById("dashboardGrid");
  grid.innerHTML=`
    <div class="grid md:grid-cols-2 gap-4">
      <div class="list-item flex flex-col">
        <h3 class="font-semibold">🎟️ Kelola Voucher</h3>
        <p class="text-sm text-gray-300">Generate, hapus, dan print voucher.</p>
        <button onclick="showSection('voucher')" class="mt-2 bg-blue-600 hover:bg-blue-700 py-2 rounded-lg font-semibold">Lihat</button>
      </div>
      <div class="list-item flex flex-col">
        <h3 class="font-semibold">📊 Laporan Keuangan</h3>
        <p class="text-sm text-gray-300">Catat dan filter laporan keuangan.</p>
        <button onclick="showSection('finance')" class="mt-2 bg-blue-600 hover:bg-blue-700 py-2 rounded-lg font-semibold">Lihat</button>
      </div>
    </div>
  `;
  document.getElementById("announcementBoard").classList.remove("hidden");
}
window.showSection=(key)=>{
  document.getElementById("dashboardGrid").classList.add("hidden");
  document.getElementById("announcementBoard").classList.add("hidden");
  document.getElementById("voucherContainer").classList.toggle("hidden", key!=="voucher");
  document.getElementById("financeContainer").classList.toggle("hidden", key!=="finance");
};
window.backToDashboard=()=>{document.querySelectorAll("#voucherContainer,#financeContainer").forEach(el=>el.classList.add("hidden"));renderDashboard();};

// ===== VOUCHER =====
window.loadVouchers=async()=>{
  const q=await getDocs(query(collection(db,"redeem_codes"),orderBy("createdAt","desc")));
  existingVouchers=[]; q.forEach(d=>existingVouchers.push({id:d.id,...d.data()}));
  renderVouchers("all");
};
window.renderVouchers=(filter)=>{
  const wrap=document.getElementById("voucherList");
  wrap.innerHTML="";
  let list=existingVouchers;
  if(filter==="used") list=list.filter(v=>v.used);
  if(filter==="unused") list=list.filter(v=>!v.used);
  if(!list.length){wrap.innerHTML=`<p class='text-gray-400 text-sm'>Belum ada data.</p>`;return;}
  list.forEach(v=>{
    wrap.innerHTML+=`
    <div class="list-item flex justify-between">
      <div>
        <p class="font-bold text-blue-300">${v.code}</p>
        <p class="small-txt">Dibuat: ${v.createdAt?.toDate?.().toLocaleString("id-ID")||"-"}</p>
        <p class="small-txt">Dipakai: ${v.used?"✅ "+(v.usedBy||"-"):"❌ Belum"}</p>
      </div>
      <div class="flex flex-col gap-1">
        <button onclick="toggleUsed('${v.id}',${v.used})" class="px-2 py-1 bg-yellow-500 rounded text-xs">🔄 ${v.used?"Reset":"Used"}</button>
        <button onclick="deleteVoucher('${v.id}')" class="px-2 py-1 bg-red-600 rounded text-xs">🗑️</button>
      </div>
    </div>`;
  });
};
window.generateVouchers=async()=>{
  const jumlah=parseInt(document.getElementById("voucherJumlah").value);
  if(!jumlah||jumlah<1||jumlah>100)return Swal.fire("Error","Jumlah harus 1–100","error");
  const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  for(let i=0;i<jumlah;i++){
    const code="CRVS"+Array.from({length:6},()=>chars[Math.floor(Math.random()*chars.length)]).join('');
    await addDoc(collection(db,"redeem_codes"),{code,used:false,createdAt:serverTimestamp(),createdBy:currentUser.uid});
  }
  Swal.fire("Berhasil",`${jumlah} voucher dibuat`,"success");
  loadVouchers();
};
window.toggleUsed=async(id,used)=>{
  await updateDoc(doc(db,"redeem_codes",id),{used:!used,usedBy:used?null:currentUser.uid,usedAt:serverTimestamp()});
  loadVouchers();
};
window.deleteVoucher=async(id)=>{
  await deleteDoc(doc(db,"redeem_codes",id));
  loadVouchers();
};

// ===== FINANCE =====
window.loadFinance=async()=>{
  const q=await getDocs(query(collection(db,"finance"),orderBy("createdAt","desc")));
  financeData=[]; q.forEach(d=>financeData.push({id:d.id,...d.data()}));
  renderFinance(financeData);
};
function renderFinance(data){
  const list=document.getElementById("financeList");
  const totalIn=data.filter(x=>x.jenis==="pemasukan").reduce((a,b)=>a+b.nominal,0);
  const totalOut=data.filter(x=>x.jenis==="pengeluaran").reduce((a,b)=>a+b.nominal,0);
  document.getElementById("financeSummary").innerHTML=`
    <div class="list-item text-center"><p>Total Pemasukan</p><h3 class="text-green-400 font-bold">Rp${totalIn.toLocaleString("id-ID")}</h3></div>
    <div class="list-item text-center"><p>Total Pengeluaran</p><h3 class="text-red-400 font-bold">Rp${totalOut.toLocaleString("id-ID")}</h3></div>
    <div class="list-item text-center"><p>Saldo Akhir</p><h3 class="text-yellow-400 font-bold">Rp${(totalIn-totalOut).toLocaleString("id-ID")}</h3></div>`;
  list.innerHTML=data.map(d=>`
    <div class="list-item flex justify-between">
      <div>
        <p class="font-semibold ${d.jenis==="pemasukan"?"text-green-400":"text-red-400"}">${d.jenis.toUpperCase()}</p>
        <p>${d.keterangan}</p>
        <p class="small-txt">${d.createdAt?.toDate?.().toLocaleString("id-ID")||"-"}</p>
      </div>
      <p>Rp${d.nominal.toLocaleString("id-ID")}</p>
    </div>`).join("");
}
window.tambahTransaksi=async()=>{
  const jenis=document.getElementById("jenisTransaksi").value;
  const nominal=Number(document.getElementById("nominalTransaksi").value);
  const ket=document.getElementById("keteranganTransaksi").value.trim();
  if(!nominal||!ket)return Swal.fire("Error","Isi lengkap semua field","error");
  await addDoc(collection(db,"finance"),{jenis,nominal,keterangan:ket,createdAt:serverTimestamp()});
  document.getElementById("nominalTransaksi").value="";
  document.getElementById("keteranganTransaksi").value="";
  loadFinance();
};
window.filterFinance=(mode)=>{
  let now=new Date();
  let filtered=financeData;
  if(mode!=="all"){
    filtered=financeData.filter(x=>{
      const t=x.createdAt?.toDate?.()||new Date();
      const diff=(now-t)/(1000*3600*24);
      if(mode==="today")return t.toDateString()===now.toDateString();
      return diff<=Number(mode);
    });
  }
  renderFinance(filtered);
};

// ===== ANNOUNCEMENT =====
function loadAnnouncements(){
  const board=document.getElementById("announcementList");
  const updates=[
    "🚀 Update 13 Okt: Dashboard baru lebih cepat & ringan",
    "📊 Tambahan filter laporan 7 dan 30 hari terakhir",
    "🎟️ Voucher system diperbarui dengan print massal"
  ];
  board.innerHTML=updates.map(u=>`<li>${u}</li>`).join("");
}
</script>
</body>
</html>
