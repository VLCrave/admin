<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Crave Street Admin</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
  .list-item { background: rgba(55,65,81,0.5); border-radius: 12px; padding: 12px; }
  .small-txt { font-size: 12px; color: #c7c7c7; }
  @media print {
    body * { visibility: hidden; }
    #printArea, #printArea * { visibility: visible; }
    #printArea { position: absolute; top:0; left:0; width:100%; }
  }
</style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-black min-h-screen text-white">

<header class="sticky top-0 bg-gray-800/90 backdrop-blur-lg z-50 px-4 py-3 flex flex-wrap items-center justify-between shadow-lg">
  <div class="flex items-center gap-2 flex-1">
    <img src="https://vlcrave.github.io/admin/logo.png" alt="Logo" class="h-8 w-8 rounded-full">
    <h1 class="text-white font-bold text-lg truncate">Crave Street</h1>
  </div>
  <div class="flex items-center gap-3">
    <div class="text-right mr-2">
      <p class="text-gray-300 text-xs">Halo, <span id="userName" class="font-semibold text-blue-400">Admin</span></p>
      <p class="text-gray-400 text-[10px]">Role: <span id="userRole" class="font-semibold text-yellow-400">Admin</span></p>
    </div>
    <img id="userPhoto" src="https://vlcrave.github.io/admin/logo.png" alt="User Photo" class="h-8 w-8 rounded-full border-2 border-blue-400">
    <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded-lg font-semibold text-white text-xs">Logout</button>
  </div>
</header>

<main class="p-4 max-w-6xl mx-auto mt-6">

  <div id="dashboardGrid" class="space-y-4"></div>

  <!-- ================= VOUCHER CONTAINER ================= -->
  <div id="voucherContainer" class="hidden mt-6 text-white">
    <button onclick="backToDashboard()" class="mb-3 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded-lg">← Kembali ke Dashboard</button>
    <h2 class="text-xl font-bold mb-3">🎟️ Kelola Voucher</h2>

    <div class="bg-gray-800/60 p-4 rounded-xl mb-3">
      <label class="block text-sm font-semibold mb-2">Jumlah Generate (1 - 100)</label>
      <input id="voucherJumlah" type="number" min="1" max="100" placeholder="Masukkan jumlah" class="w-full px-3 py-2 rounded-lg bg-gray-700 text-white mb-3 focus:outline-none">
      <div class="flex gap-2">
        <button id="genBtn" onclick="generateVouchers()" class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-lg font-semibold">➕ Generate</button>
        <button onclick="loadVouchers()" class="bg-gray-600 hover:bg-gray-700 px-3 py-2 rounded-lg">🔄 Refresh</button>
        <button onclick="printAllVouchers()" class="bg-purple-600 hover:bg-purple-700 px-3 py-2 rounded-lg">🖨️ Print Semua</button>
      </div>
    </div>

    <div class="mb-2 flex gap-2">
      <button onclick="renderVouchers('all')" class="bg-gray-700 px-3 py-1 rounded-lg">Semua</button>
      <button onclick="renderVouchers('unused')" class="bg-gray-700 px-3 py-1 rounded-lg">Belum Dipakai</button>
      <button onclick="renderVouchers('used')" class="bg-gray-700 px-3 py-1 rounded-lg">Sudah Dipakai</button>
    </div>

    <div id="voucherList" class="space-y-3 max-h-96 overflow-y-auto pb-6"></div>
  </div>

  <!-- ================= SPINWHEEL CONTAINER ================= -->
  <div id="spinContainer" class="hidden mt-6 text-white">
    <button onclick="backToDashboard()" class="mb-3 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded-lg">← Kembali ke Dashboard</button>
    <h2 class="text-xl font-bold mb-3">🎡 Kelola Spin Wheel</h2>

    <!-- Form Tambah Hadiah -->
    <div class="bg-gray-800/60 p-4 rounded-xl mb-3">
      <h3 class="font-semibold mb-2">Tambah Hadiah</h3>
      <div class="grid grid-cols-3 gap-2">
        <input id="prizeName" type="text" placeholder="Nama hadiah" class="bg-gray-700 rounded-lg p-2 col-span-1" />
        <input id="prizeChance" type="number" min="0" max="100" placeholder="Chance (weight / %)" class="bg-gray-700 rounded-lg p-2 col-span-1" />
        <input id="prizeTotal" type="number" min="0" placeholder="Total kuota (0 = unlimited)" class="bg-gray-700 rounded-lg p-2 col-span-1" />
      </div>
      <div class="mt-3 flex gap-2">
        <button onclick="addPrize()" class="bg-green-600 hover:bg-green-700 px-3 py-2 rounded-lg font-semibold">➕ Tambah Hadiah</button>
        <button onclick="loadSpinPrizes()" class="bg-gray-700 px-3 py-2 rounded-lg">🔄 Refresh</button>
      </div>
    </div>

    <!-- Prize list -->
    <div class="mb-2">
      <h4 class="text-sm text-gray-300 mb-2">Daftar Hadiah</h4>
      <div id="prizeList" class="space-y-3 max-h-72 overflow-y-auto pb-6"></div>
    </div>

    <!-- Winners -->
    <div class="mt-6">
      <h3 class="font-semibold mb-2">📥 Data Pemenang</h3>
      <div class="bg-gray-800/60 p-3 rounded-xl mb-2">
        <div class="flex gap-2">
          <button onclick="loadSpinWinners('pending')" class="bg-yellow-500 px-3 py-2 rounded">Pending</button>
          <button onclick="loadSpinWinners('approved')" class="bg-green-600 px-3 py-2 rounded">Approved</button>
          <button onclick="loadSpinWinners('rejected')" class="bg-red-600 px-3 py-2 rounded">Rejected</button>
          <button onclick="loadSpinWinners('all')" class="bg-gray-700 px-3 py-2 rounded">All</button>
        </div>
      </div>
      <div id="winnersList" class="space-y-3 max-h-80 overflow-y-auto pb-6"></div>
    </div>
  </div>

  <!-- ================= FINANCE CONTAINER ================= -->
  <div id="financeContainer" class="hidden mt-6 text-white">
    <button onclick="backToDashboard()" class="mb-3 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded-lg">← Kembali ke Dashboard</button>
    <h2 class="text-xl font-bold mb-3">📊 Laporan Keuangan</h2>

    <!-- SALDO BOX (DI ATAS RINGKASAN) -->
    <div id="saldoBoxes" class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4"></div>

    <!-- SUMMARY CARDS -->
    <div id="financeSummary" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 mb-4"></div>

    <!-- Form Tambah -->
    <div class="bg-gray-800/60 p-4 rounded-xl mb-4">
      <h3 class="font-semibold mb-2">Tambah Transaksi</h3>
      <div class="grid grid-cols-2 gap-2">
        <select id="jenisTransaksi" class="bg-gray-700 rounded-lg p-2">
          <option value="pemasukan">Pemasukan</option>
          <option value="pengeluaran">Pengeluaran</option>
        </select>
        <input id="nominalTransaksi" type="number" placeholder="Nominal (Rp)" class="bg-gray-700 rounded-lg p-2">
      </div>
      <input id="keteranganTransaksi" type="text" placeholder="Keterangan" class="bg-gray-700 rounded-lg p-2 w-full mt-2">
      <button onclick="tambahTransaksi()" class="mt-3 bg-green-600 hover:bg-green-700 px-3 py-2 rounded-lg w-full font-semibold">➕ Simpan Transaksi</button>
    </div>

    <!-- Daftar Laporan -->
    <div id="financeList" class="space-y-3 max-h-96 overflow-y-auto"></div>
  </div>

  <div id="printArea" class="hidden"></div>

</main>

<script type="module">
/* FULL FINAL - Integrasi Spin Wheel CRUD & Winners + voucher/finance dari original file
   Perubahan utama: menambahkan spin_prizes CRUD & spin_winners approval flow
*/

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import {
  getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc,
  orderBy, query, serverTimestamp, getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAzzr0ChjdVi7m4Ge-EFm3OK43ASujjZ40",
  authDomain: "crave-street-id.firebaseapp.com",
  projectId: "crave-street-id",
  storageBucket: "crave-street-id.firebasestorage.app",
  messagingSenderId: "221955592583",
  appId: "1:221955592583:web:43dc59d791e750095cc322",
  measurementId: "G-WCRQGLW47B"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let existingVouchers = [];
let existingPrizes = [];

const voucherListEl = document.getElementById("voucherList");
const financeSummaryEl = document.getElementById("financeSummary");
const saldoBoxesEl = document.getElementById("saldoBoxes");
const prizeListEl = document.getElementById("prizeList");
const winnersListEl = document.getElementById("winnersList");

// ====== AUTH ======
onAuthStateChanged(auth, async (user) => {
  if(!user) return window.location.href = "login.html";
  currentUser = user;
  document.getElementById("userName").innerText = user.displayName || "Admin";
  document.getElementById("userRole").innerText = "Admin";
  renderDashboard();
  await loadVouchers();
  await loadFinance();
  await loadSpinPrizes();
  await loadSpinWinners('pending');
});

window.logout = ()=>signOut(auth).then(()=>window.location.href="// ===== DASHBOARD =====
function renderDashboard(){
  document.getElementById("voucherContainer").classList.add("hidden");
  document.getElementById("financeContainer").classList.add("hidden");
  document.getElementById("spinContainer").classList.add("hidden");
  const grid = document.getElementById("dashboardGrid");
  grid.innerHTML = "";
  
  // Welcome Section
  const welcomeDiv = document.createElement("div");
  welcomeDiv.className = "bg-gradient-to-r from-blue-600/20 to-purple-600/20 border border-blue-500/30 rounded-2xl p-6 mb-6 backdrop-blur-sm";
  welcomeDiv.innerHTML = `
    <div class="flex items-center gap-4">
      <div class="bg-blue-500/20 p-4 rounded-full">
        <svg class="w-12 h-12 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
        </svg>
      </div>
      <div class="flex-1">
        <h2 class="text-2xl font-bold text-white mb-1">Selamat Datang, <span id="welcomeName" class="text-blue-400"></span>! 👋</h2>
        <p class="text-gray-300">Kelola bisnis Crave Street dengan mudah melalui dashboard admin</p>
      </div>
    </div>
  `;
  grid.appendChild(welcomeDiv);
  
  const modules = [
    {
      key:"voucher", 
      title:"Kelola Voucher", 
      icon:"🎟️",
      desc:"Generate, kelola, dan pantau voucher redeem untuk pelanggan",
      color:"from-green-600/20 to-emerald-600/20",
      border:"border-green-500/30",
      btnColor:"bg-green-600 hover:bg-green-700"
    },
    {
      key:"spin", 
      title:"Spin Wheel", 
      icon:"🎡",
      desc:"Atur hadiah spin wheel dan verifikasi pemenang undian",
      color:"from-purple-600/20 to-pink-600/20",
      border:"border-purple-500/30",
      btnColor:"bg-purple-600 hover:bg-purple-700"
    },
    {
      key:"finance", 
      title:"Laporan Keuangan", 
      icon:"📊",
      desc:"Catat transaksi, pantau pemasukan dan pengeluaran bisnis",
      color:"from-blue-600/20 to-cyan-600/20",
      border:"border-blue-500/30",
      btnColor:"bg-blue-600 hover:bg-blue-700"
    }
  ];
  
  const cardsContainer = document.createElement("div");
  cardsContainer.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4";
  
  modules.forEach(mod=>{
    const card = document.createElement("div");
    card.className=`bg-gradient-to-br ${mod.color} ${mod.border} border rounded-2xl p-6 backdrop-blur-sm hover:scale-105 transition-transform duration-300 cursor-pointer group`;
    card.innerHTML=`
      <div class="flex flex-col h-full">
        <div class="flex items-start justify-between mb-4">
          <div class="bg-white/10 p-3 rounded-xl group-hover:scale-110 transition-transform">
            <span class="text-4xl">${mod.icon}</span>
          </div>
          <div class="bg-white/5 px-2 py-1 rounded-full">
            <span class="text-xs text-gray-300">Module</span>
          </div>
        </div>
        <div class="flex-1">
          <h3 class="text-xl font-bold text-white mb-2">${mod.title}</h3>
          <p class="text-sm text-gray-300 leading-relaxed">${mod.desc}</p>
        </div>
        <button onclick="showSection('${mod.key}')" class="mt-4 w-full ${mod.btnColor} py-3 rounded-xl font-semibold text-white flex items-center justify-center gap-2 group-hover:shadow-lg transition-all">
          <span>Buka Module</span>
          <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
          </svg>
        </button>
      </div>
    `;
    cardsContainer.appendChild(card);
  });
  
  grid.appendChild(cardsContainer);
  
  // Announcement & Update Logs Section
  const infoSection = document.createElement("div");
  infoSection.className = "grid grid-cols-1 lg:grid-cols-2 gap-4 mt-6";
  
  // Announcement Board
  const announcementDiv = document.createElement("div");
  announcementDiv.className = "bg-gradient-to-br from-orange-600/20 to-red-600/20 border border-orange-500/30 rounded-2xl p-6 backdrop-blur-sm";
  announcementDiv.innerHTML = `
    <div class="flex items-center gap-3 mb-4">
      <div class="bg-orange-500/20 p-2 rounded-lg">
        <svg class="w-6 h-6 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path>
        </svg>
      </div>
      <h3 class="text-xl font-bold text-white">📢 Papan Pengumuman</h3>
    </div>
    <div class="space-y-3 max-h-64 overflow-y-auto pr-2" id="announcementList">
      <div class="bg-white/5 rounded-xl p-4 border border-orange-500/20">
        <div class="flex items-start gap-3">
          <span class="text-2xl">🎉</span>
          <div class="flex-1">
            <div class="flex items-center justify-between mb-1">
              <h4 class="font-semibold text-orange-300">Selamat Datang!</h4>
              <span class="text-xs text-gray-400">Hari ini</span>
            </div>
            <p class="text-sm text-gray-300">Sistem admin Crave Street telah siap digunakan. Kelola voucher, spin wheel, dan keuangan dengan mudah.</p>
          </div>
        </div>
      </div>
      <div class="bg-white/5 rounded-xl p-4 border border-orange-500/20">
        <div class="flex items-start gap-3">
          <span class="text-2xl">⚠️</span>
          <div class="flex-1">
            <div class="flex items-center justify-between mb-1">
              <h4 class="font-semibold text-yellow-300">Penting!</h4>
              <span class="text-xs text-gray-400">Baru</span>
            </div>
            <p class="text-sm text-gray-300">Penarikan saldo hanya dapat dilakukan pada tanggal 11 dan 29 setiap bulan. Pastikan data keuangan akurat.</p>
          </div>
        </div>
      </div>
      <div class="bg-white/5 rounded-xl p-4 border border-orange-500/20">
        <div class="flex items-start gap-3">
          <span class="text-2xl">💡</span>
          <div class="flex-1">
            <div class="flex items-center justify-between mb-1">
              <h4 class="font-semibold text-blue-300">Tips</h4>
              <span class="text-xs text-gray-400">Info</span>
            </div>
            <p class="text-sm text-gray-300">Gunakan fitur print untuk mencetak voucher secara batch. Refresh data secara berkala untuk informasi terkini.</p>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Update Logs
  const updateLogsDiv = document.createElement("div");
  updateLogsDiv.className = "bg-gradient-to-br from-indigo-600/20 to-blue-600/20 border border-indigo-500/30 rounded-2xl p-6 backdrop-blur-sm";
  updateLogsDiv.innerHTML = `
    <div class="flex items-center gap-3 mb-4">
      <div class="bg-indigo-500/20 p-2 rounded-lg">
        <svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
      </div>
      <h3 class="text-xl font-bold text-white">🔄 Log Update</h3>
    </div>
    <div class="space-y-3 max-h-64 overflow-y-auto pr-2" id="updateLogsList">
      <div class="bg-white/5 rounded-xl p-3 border-l-4 border-green-500">
        <div class="flex items-center justify-between mb-1">
          <span class="text-xs font-semibold text-green-400 uppercase">v2.1.0 - Latest</span>
          <span class="text-xs text-gray-400">13 Okt 2025</span>
        </div>
        <ul class="text-sm text-gray-300 space-y-1 ml-3">
          <li class="flex items-start gap-2">
            <span class="text-green-400 mt-1">•</span>
            <span>Tambah papan pengumuman & log update</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-400 mt-1">•</span>
            <span>Perbaikan UI/UX dashboard utama</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-400 mt-1">•</span>
            <span>Optimasi performa loading data</span>
          </li>
        </ul>
      </div>
      <div class="bg-white/5 rounded-xl p-3 border-l-4 border-blue-500">
        <div class="flex items-center justify-between mb-1">
          <span class="text-xs font-semibold text-blue-400 uppercase">v2.0.5</span>
          <span class="text-xs text-gray-400">10 Okt 2025</span>
        </div>
        <ul class="text-sm text-gray-300 space-y-1 ml-3">
          <li class="flex items-start gap-2">
            <span class="text-blue-400 mt-1">•</span>
            <span>Fitur approval spin wheel winners</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-blue-400 mt-1">•</span>
            <span>Sistem arsip keuangan otomatis</span>
          </li>
        </ul>
      </div>
      <div class="bg-white/5 rounded-xl p-3 border-l-4 border-purple-500">
        <div class="flex items-center justify-between mb-1">
          <span class="text-xs font-semibold text-purple-400 uppercase">v2.0.0</span>
          <span class="text-xs text-gray-400">5 Okt 2025</span>
        </div>
        <ul class="text-sm text-gray-300 space-y-1 ml-3">
          <li class="flex items-start gap-2">
            <span class="text-purple-400 mt-1">•</span>
            <span>Rilis sistem manajemen spin wheel</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-purple-400 mt-1">•</span>
            <span>Integrasi pengelolaan hadiah & pemenang</span>
          </li>
        </ul>
      </div>
      <div class="bg-white/5 rounded-xl p-3 border-l-4 border-yellow-500">
        <div class="flex items-center justify-between mb-1">
          <span class="text-xs font-semibold text-yellow-400 uppercase">v1.5.0</span>
          <span class="text-xs text-gray-400">1 Okt 2025</span>
        </div>
        <ul class="text-sm text-gray-300 space-y-1 ml-3">
          <li class="flex items-start gap-2">
            <span class="text-yellow-400 mt-1">•</span>
            <span>Fitur print voucher batch & QR code</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-yellow-400 mt-1">•</span>
            <span>Sistem filter voucher (used/unused)</span>
          </li>
        </ul>
      </div>
    </div>
  `;
  
  infoSection.appendChild(announcementDiv);
  infoSection.appendChild(updateLogsDiv);
  grid.appendChild(infoSection);
  
  // Set welcome name
  setTimeout(()=>{
    const nameEl = document.getElementById("welcomeName");
    if(nameEl && currentUser){
      nameEl.textContent = currentUser.displayName || "Admin";
    }
  }, 100);
}
// ---------------------------
// ===== VOUCHER PART (CRUD) =
// ---------------------------
window.loadVouchers = async () => {
  try {
    const snap = await getDocs(query(collection(db, "redeem_codes"), orderBy("createdAt","desc")));
    existingVouchers = [];
    snap.forEach(d=> existingVouchers.push({id:d.id, ...d.data()}));
    renderVouchers("all", existingVouchers);
    return existingVouchers;
  } catch (e) {
    console.error("loadVouchers err:", e);
    voucherListEl.innerHTML = `<p class="text-red-400 text-sm">Gagal memuat voucher.</p>`;
    return [];
  }
};

window.renderVouchers = (filter="all", vouchers=null) => {
  voucherListEl.innerHTML = "";
  const arr = vouchers || existingVouchers;
  let filtered = arr;
  if(filter === "used") filtered = arr.filter(v => v.used);
  if(filter === "unused") filtered = arr.filter(v => !v.used);
  if(filtered.length === 0){
    voucherListEl.innerHTML = `<p class="text-gray-400 text-sm">Belum ada voucher.</p>`; 
    return;
  }

  const formatDate = (ts) => {
    try { if(!ts) return "-"; const date = ts.toDate ? ts.toDate() : new Date(ts); return date.toLocaleDateString("id-ID", {day:"2-digit", month:"long", year:"numeric"}) + " " + date.toLocaleTimeString("id-ID", {hour:"2-digit", minute:"2-digit"}); } catch { return "-"; }
  };

  filtered.forEach(v => {
    const div = document.createElement("div");
    div.id = "v-" + v.id;
    div.className = "list-item flex flex-col gap-2";
    const createdDate = formatDate(v.createdAt);
    const usedDate = formatDate(v.usedAt);

    div.innerHTML = `
      <div class="flex justify-between items-start">
        <div>
          <div class="flex items-center gap-2">
            <p class="font-bold text-blue-300">${v.code}</p>
            <button onclick="copyToClipboard('${v.code}')" class="px-1 py-0.5 bg-gray-500 hover:bg-gray-600 text-white rounded text-xs">📋 Salin</button>
          </div>
          <p class="small-txt">Dibuat: ${createdDate}</p>
          <p class="small-txt">Voucher Digunakan Oleh: ${v.used ? v.usedBy || "-" : "-"}</p>
          <p class="small-txt">Tanggal Digunakan: ${v.used ? usedDate : "-"}</p>
        </div>
        <div class="flex flex-col gap-1">
          <button onclick="toggleUsed('${v.id}',${v.used})" class="px-2 py-1 bg-yellow-500 hover:bg-yellow-600 rounded text-xs">🔄 ${v.used?"Reset":"Used"}</button>
          <button onclick="deleteVoucher('${v.id}')" class="px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">🗑️ Hapus</button>
          <button onclick="printVoucher('${v.code}')" class="px-2 py-1 bg-purple-600 hover:bg-purple-700 rounded text-xs">🖨️ Print</button>
        </div>
      </div>
    `;
    voucherListEl.appendChild(div);
  });
};

window.copyToClipboard = (text)=>navigator.clipboard.writeText(text).then(()=>Swal.fire("Berhasil","Kode voucher disalin","success")).catch(()=>Swal.fire("Error","Gagal salin","error"));

window.generateVouchers = async ()=>{
  let jumlah = parseInt(document.getElementById("voucherJumlah").value);
  if(!jumlah || jumlah<1 || jumlah>100){ Swal.fire("Error","Jumlah harus 1-100","error"); return; }
  const btn = document.getElementById("genBtn"); btn.disabled=true; btn.innerText="Generating...";
  try{
    await loadVouchers();
    const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    const created=[];
    for(let i=0;i<jumlah;i++){
      let code, attempts=0;
      do{
        code="CRVS"+Array.from({length:6},()=>chars[Math.floor(Math.random()*chars.length)]).join('');
        attempts++;
        if(attempts>200) throw new Error("Gagal buat kode unik");
      }while(existingVouchers.some(v=>v.code===code));
      const docRef = await addDoc(collection(db,"redeem_codes"),{
        code, used:false, usedBy:null, usedAt:null, createdAt:serverTimestamp(), createdBy:currentUser.displayName||"Admin"
      });
      created.push({id:docRef.id, code});
    }
    document.getElementById("voucherJumlah").value="";
    Swal.fire("Berhasil",`Generated ${created.length} voucher`,"success");
    await loadVouchers();
  }catch(err){ console.error(err); Swal.fire("Error",err.message||"Gagal generate","error"); }
  finally{ btn.disabled=false; btn.innerText="➕ Generate"; }
};

window.deleteVoucher = async (id)=>{
  const v = existingVouchers.find(x=>x.id===id);
  const res = await Swal.fire({
    title: `Hapus ${v?.code || 'voucher'}?`,
    text: "Voucher akan dihapus permanen.",
    icon: "warning",
    showCancelButton:true,
    confirmButtonText:"Hapus"
  });
  if(!res.isConfirmed) return;
  await deleteDoc(doc(db,"redeem_codes",id));
  Swal.fire("Dihapus","Voucher berhasil dihapus.","success");
  await loadVouchers();
};

window.toggleUsed = async (id,current)=>{
  const v = existingVouchers.find(x=>x.id===id);
  if(!current){
    const { value: usedBy } = await Swal.fire({
      title:'Tandai sebagai Dipakai',
      input:'text',
      inputLabel:'Masukkan email/UID user',
      showCancelButton:true
    });
    if(usedBy===undefined) return;
    await updateDoc(doc(db,"redeem_codes",id),{used:true,usedBy:usedBy||currentUser.uid,usedAt:serverTimestamp()});
  } else {
    const res = await Swal.fire({
      title:'Reset jadi Belum Dipakai?',
      text:'Voucher akan di-set unused.',
      icon:'warning',
      showCancelButton:true,
      confirmButtonText:'Reset'
    });
    if(!res.isConfirmed) return;
    await updateDoc(doc(db,"redeem_codes",id),{used:false,usedBy:null,usedAt:null});
  }
  await loadVouchers();
};

window.printVoucher = (code)=>{
  const html = `
    <div style="text-align:center; font-family:sans-serif; padding:20px;">
      <img src="https://vlcrave.github.io/admin/logo.png" style="height:50px; margin-bottom:10px;" />
      <h2>Crave Street Voucher</h2>
      <p style="font-size:20px; font-weight:bold;">${code}</p>
      <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${code}" />
      <p>Scan kode voucher untuk mendapatkan hadiah</p>
    </div>`;
  const w = window.open(); w.document.write(html); w.print(); w.close();
};

window.printAllVouchers = async ()=>{
  const vouchers = await loadVouchers();
  if(!vouchers.length){ Swal.fire("Info","Tidak ada voucher untuk dicetak","info"); return; }
  const html = `
    <html><head><title>Print Vouchers</title><style>body{font-family:Arial;padding:20px;} .voucher{border:1px solid #000;width:300px;height:150px;margin:10px;padding:10px;display:inline-block;vertical-align:top;} .voucher-code{font-size:18px;margin-bottom:5px;font-weight:bold;}</style></head>
    <body>${vouchers.map(v=>`
      <div class="voucher">
        <div>CraveStreet Redeem</div>
        <div class="voucher-code">${v.code}</div>
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=${v.code}" />
        <div>Scan untuk menyalin kode Redeem</div>
      </div>`).join("")}</body></html>`;
  const w = window.open(); w.document.write(html); w.print(); w.close();
};

// ---------------------------
// ===== SPINWHEEL PART ======
// ---------------------------

window.loadSpinPrizes = async () => {
  prizeListEl.innerHTML = "<p class='text-gray-400 text-sm'>Memuat hadiah...</p>";
  try {
    const snap = await getDocs(query(collection(db, "spin_prizes"), orderBy("createdAt","desc")));
    existingPrizes = [];
    snap.forEach(d=> existingPrizes.push({id:d.id, ...d.data()}));
    renderSpinPrizes(existingPrizes);
    return existingPrizes;
  } catch (e) {
    console.error("loadSpinPrizes err:", e);
    prizeListEl.innerHTML = `<p class="text-red-400 text-sm">Gagal memuat hadiah.</p>`;
    return [];
  }
};

function renderSpinPrizes(arr){
  prizeListEl.innerHTML = "";
  if(!arr || arr.length === 0){
    prizeListEl.innerHTML = `<p class="text-gray-400 text-sm">Belum ada hadiah.</p>`;
    return;
  }
  arr.forEach(p=>{
    const div = document.createElement("div");
    div.className = "list-item flex justify-between items-center";
    div.innerHTML = `
      <div>
        <p class="font-semibold text-blue-200">${p.name}</p>
        <p class="small-txt">Chance: ${p.chance} — Total: ${p.total === 0 ? 'Unlimited' : p.total}</p>
        <p class="small-txt">Dibuat: ${p.createdAt && p.createdAt.toDate ? p.createdAt.toDate().toLocaleString("id-ID") : '-'}</p>
      </div>
      <div class="flex flex-col gap-1">
        <button data-id="${p.id}" class="btn-edit px-2 py-1 bg-yellow-500 hover:bg-yellow-600 rounded text-xs">✏️ Edit</button>
        <button data-id="${p.id}" class="btn-delete px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">🗑️ Hapus</button>
      </div>
    `;
    prizeListEl.appendChild(div);
  });

  // attach listeners
  const editBtns = prizeListEl.querySelectorAll(".btn-edit");
  editBtns.forEach(b=> b.addEventListener("click", async (e)=>{
    const id = e.currentTarget.dataset.id;
    await editPrize(id);
  }));
  const delBtns = prizeListEl.querySelectorAll(".btn-delete");
  delBtns.forEach(b=> b.addEventListener("click", async (e)=>{
    const id = e.currentTarget.dataset.id;
    await deletePrize(id);
  }));
}

window.addPrize = async ()=>{
  const name = (document.getElementById("prizeName").value||"").trim();
  const chance = Number(document.getElementById("prizeChance").value||0);
  const total = Number(document.getElementById("prizeTotal").value||0);

  if(!name){ Swal.fire("Error","Nama hadiah wajib diisi","error"); return; }
  if(isNaN(chance) || chance < 0){ Swal.fire("Error","Chance harus berupa angka >= 0","error"); return; }
  if(isNaN(total) || total < 0){ Swal.fire("Error","Total harus >= 0","error"); return; }

  try {
    await addDoc(collection(db,"spin_prizes"), {
      name, chance, total, createdAt: serverTimestamp(), createdBy: currentUser.displayName || currentUser.uid
    });
    Swal.fire("Berhasil","Hadiah ditambahkan","success");
    document.getElementById("prizeName").value="";
    document.getElementById("prizeChance").value="";
    document.getElementById("prizeTotal").value="";
    await loadSpinPrizes();
  } catch (e) {
    console.error("addPrize err:", e);
    Swal.fire("Error","Gagal tambah hadiah","error");
  }
};

async function editPrize(id){
  try {
    const docRef = doc(db,"spin_prizes", id);
    const snap = await getDoc(docRef);
    if(!snap.exists()) { Swal.fire("Error","Hadiah tidak ditemukan","error"); return; }
    const data = snap.data();
    const { value: formValues } = await Swal.fire({
      title:"Edit Hadiah",
      html:`
        <input id="editName" class="swal2-input" placeholder="Nama" value="${(data.name||'').replace(/"/g,'&quot;')}" />
        <input id="editChance" type="number" class="swal2-input" placeholder="Chance" value="${data.chance||0}" />
        <input id="editTotal" type="number" class="swal2-input" placeholder="Total (0 unlimited)" value="${data.total||0}" />
      `,
      focusConfirm:false,
      preConfirm: ()=>[
        document.getElementById("editName").value,
        document.getElementById("editChance").value,
        document.getElementById("editTotal").value
      ]
    });
    if(!formValues) return;
    const [name, chance, total] = formValues;
    await updateDoc(docRef, { name: name.trim(), chance: Number(chance), total: Number(total) });
    Swal.fire("Disimpan","Perubahan tersimpan","success");
    await loadSpinPrizes();
  } catch (e) {
    console.error("editPrize err:", e);
    Swal.fire("Error","Gagal edit hadiah","error");
  }
}

async function deletePrize(id){
  const p = existingPrizes.find(x=>x.id===id);
  const res = await Swal.fire({ title:`Hapus hadiah "${p?.name||''}"?`, text:"Data akan dihapus permanen.", icon:"warning", showCancelButton:true, confirmButtonText:"Hapus" });
  if(!res.isConfirmed) return;
  try {
    await deleteDoc(doc(db,"spin_prizes", id));
    Swal.fire("Dihapus","Hadiah dihapus","success");
    await loadSpinPrizes();
  } catch (e) {
    console.error("deletePrize err:", e);
    Swal.fire("Error","Gagal menghapus hadiah","error");
  }
}

// ---------------------------
// ===== SPIN WINNERS ========
// ---------------------------

window.loadSpinWinners = async (filter='pending')=>{
  winnersListEl.innerHTML = "<p class='text-gray-400 text-sm'>Memuat pemenang...</p>";
  try{
    const snap = await getDocs(query(collection(db,"spin_winners"), orderBy("createdAt","desc")));
    const arr = [];
    snap.forEach(d=> arr.push({ id:d.id, ...d.data() }));
    renderSpinWinners(arr, filter);
  } catch(e){
    console.error("loadSpinWinners err:", e);
    winnersListEl.innerHTML = `<p class="text-red-400 text-sm">Gagal memuat pemenang.</p>`;
  }
};

function renderSpinWinners(arr, filter){
  winnersListEl.innerHTML = "";
  let filtered = arr;
  if(filter && filter !== 'all') filtered = arr.filter(x => (x.status||'pending') === filter);
  if(filtered.length === 0){
    winnersListEl.innerHTML = `<p class="text-gray-400 text-sm">Belum ada pemenang untuk filter ini.</p>`;
    return;
  }
  filtered.forEach(w=>{
    const div = document.createElement("div");
    div.className = "list-item flex justify-between items-start";
    const created = w.createdAt && w.createdAt.toDate ? w.createdAt.toDate().toLocaleString("id-ID") : '-';
    div.innerHTML = `
      <div>
        <p class="font-semibold">${w.name || w.uid}</p>
        <p class="small-txt">Prize: ${w.prizeName || w.prizeId || '-'} — Status: <span class="font-medium">${w.status||'pending'}</span></p>
        <p class="small-txt">Waktu: ${created}</p>
      </div>
      <div class="flex flex-col gap-1">
        <button data-id="${w.id}" class="btn-approve px-2 py-1 bg-green-600 hover:bg-green-700 rounded text-xs ${w.status === 'approved' ? 'opacity-60 pointer-events-none' : ''}">✔️ Approve</button>
        <button data-id="${w.id}" class="btn-reject px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs ${w.status === 'rejected' ? 'opacity-60 pointer-events-none' : ''}">✖️ Tolak</button>
      </div>
    `;
    winnersListEl.appendChild(div);
  });

  // attach listeners
  const aBtns = winnersListEl.querySelectorAll(".btn-approve");
  aBtns.forEach(b => b.addEventListener("click", async (e)=>{
    const id = e.currentTarget.dataset.id;
    await reviewWinner(id, 'approved');
  }));
  const rBtns = winnersListEl.querySelectorAll(".btn-reject");
  rBtns.forEach(b => b.addEventListener("click", async (e)=>{
    const id = e.currentTarget.dataset.id;
    await reviewWinner(id, 'rejected');
  }));
}

async function reviewWinner(id, action){
  const nameAction = action === 'approved' ? 'Approve' : 'Tolak';
  const res = await Swal.fire({ title:`${nameAction} pemenang ini?`, showCancelButton:true, confirmButtonText: nameAction });
  if(!res.isConfirmed) return;
  try{
    await updateDoc(doc(db,"spin_winners", id), {
      status: action, reviewedBy: currentUser.uid, reviewedAt: serverTimestamp()
    });
    Swal.fire("Sukses", `Pemenang telah ${action}`, "success");
    await loadSpinWinners('pending');
  } catch(e){
    console.error("reviewWinner err:", e);
    Swal.fire("Error","Gagal update status pemenang","error");
  }
}

// ---------------------------
// ===== FINANCE PART ========
// ---------------------------

// helper: archive exists?
async function archiveExists(periodKey){
  const snap = await getDocs(query(collection(db,"finance_archive")));
  let found = false;
  snap.forEach(d=>{
    if(d.data()?.periodKey === periodKey) found = true;
  });
  return found;
}

// helper: withdraw_exists for periodKey
async function withdrawExists(periodKey){
  const snap = await getDocs(query(collection(db,"withdraw_logs")));
  let found = false;
  snap.forEach(d=>{
    if(d.data()?.periodKey === periodKey) found = true;
  });
  return found;
}

// helper: update withdraw_balance docs for all existing admin docs (or create if not exist for current user)
async function updateAllWithdrawBalances(perAdminAmount){
  // get all docs in withdraw_balance
  const snap = await getDocs(query(collection(db,"withdraw_balance")));
  const existing = [];
  snap.forEach(d=> existing.push({id:d.id, data:d.data()}));
  // update all existing docs
  for(const docItem of existing){
    await updateDoc(doc(db,"withdraw_balance",docItem.id), {
      balance: perAdminAmount, name: docItem.data.name || "Admin", updatedAt: serverTimestamp()
    });
  }
  // ensure current user has doc
  if(currentUser){
    const curRef = doc(db,"withdraw_balance", currentUser.uid);
    const curSnap = await getDoc(curRef);
    if(!curSnap.exists()){
      // create
      await setDoc(curRef, { name: currentUser.displayName || "Admin", balance: perAdminAmount, updatedAt: serverTimestamp() });
    }
  }
}

// helper: update finance_meta saldo_kas (overwrite to current kas)
async function updateFinanceMetaKas(kasAmount){
  const metaRef = doc(db,"finance_meta","meta");
  const metaSnap = await getDoc(metaRef);
  if(!metaSnap.exists()){
    await setDoc(metaRef, { saldo_kas: kasAmount, updatedAt: serverTimestamp() });
  } else {
    const prev = metaSnap.data()?.saldo_kas || 0;
    if(prev !== kasAmount){
      // write history
      await addDoc(collection(db,"cash_history"), { amount: kasAmount, prevAmount: prev, createdAt: serverTimestamp(), createdBy: currentUser?.displayName || "Admin" });
      await updateDoc(metaRef, { saldo_kas: kasAmount, updatedAt: serverTimestamp() });
    }
  }
}

// render saldo boxes UI (button always clickable, swal handling in handler)
function renderSaldoBoxesUI(perAdminAmount, saldoKasAmount){
  const formatRp = (n)=> "Rp" + Number(n||0).toLocaleString("id-ID");

  saldoBoxesEl.innerHTML = `
    <div class="p-3 rounded-lg bg-yellow-700/20 border border-yellow-600">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs text-gray-200">Saldo Dapat Ditarik (35% Laba Kotor per admin)</p>
          <p class="text-2xl font-bold">${formatRp(perAdminAmount)}</p>
        </div>
        <div class="text-2xl">💸</div>
      </div>
      <div class="mt-2 flex gap-2">
        <button id="btnTarik" onclick="handleWithdraw()" class="mt-2 w-full bg-yellow-500 hover:bg-yellow-600 py-2 rounded font-semibold">Tarik Sekarang</button>
        <button onclick="lihatDetailWithdraw()" class="mt-2 px-3 py-2 bg-gray-700 rounded">Lihat Detail</button>
      </div>
    </div>

    <div class="p-3 rounded-lg bg-blue-700/20 border border-blue-600">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs text-gray-200">Saldo Kas (Usaha) — 30% Laba Kotor</p>
          <p class="text-2xl font-bold">${formatRp(saldoKasAmount)}</p>
        </div>
        <div class="text-2xl">🏦</div>
      </div>
      <div class="mt-2 flex gap-2">
        <button onclick="lihatDetailKas()" class="mt-2 px-3 py-2 bg-gray-700 rounded">Lihat Detail</button>
      </div>
    </div>
  `;
}

// handle withdraw click (global)
window.handleWithdraw = async function(){
  const today = new Date();
  const d = today.getDate();
  const periodKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${d}`;

  // if not 11 or 29 -> swal and exit
  if(!(d === 11 || d === 29)){
    Swal.fire({
      icon: "info",
      title: "Belum Waktunya",
      text: "Penarikan hanya bisa dilakukan pada tanggal 11 dan 29 setiap bulan.",
      confirmButtonText: "Oke"
    });
    return;
  }

  // compute laba
  const snap = await getDocs(query(collection(db,"finance_reports")));
  let totalPemasukan = 0, totalPengeluaran = 0;
  snap.forEach(docSnap=>{
    const it = docSnap.data();
    if(it.jenis === 'pemasukan') totalPemasukan += Number(it.nominal||0);
    if(it.jenis === 'pengeluaran') totalPengeluaran += Number(it.nominal||0);
  });
  const laba = totalPemasukan - totalPengeluaran;
  const perAdminAmount = Math.floor(laba * 0.35);

  if(perAdminAmount <= 0){
    Swal.fire("Tidak Ada Saldo","Belum ada laba untuk ditarik saat ini.","info");
    return;
  }

  // check if this period already withdrawn by this user
  const wlSnap = await getDocs(query(collection(db,"withdraw_logs")));
  let already = false;
  wlSnap.forEach(d=>{
    const dt = d.data();
    if(dt.periodKey === periodKey && dt.uid === currentUser.uid) already = true;
  });
  if(already){
    Swal.fire("Sudah Ditarik","Kamu sudah melakukan penarikan untuk periode ini.","info");
    return;
  }

  const res = await Swal.fire({
    title: `Tarik ${formatRp(perAdminAmount)}?`,
    text: "Konfirmasi penarikan — saldo admin akan diset 0 untuk periode ini.",
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "Tarik"
  });
  if(!res.isConfirmed) return;

  // write withdraw log and reset this user's withdraw_balance
  await addDoc(collection(db,"withdraw_logs"), {
    periodKey, uid: currentUser.uid, name: currentUser.displayName || "Admin",
    amount: perAdminAmount, createdAt: serverTimestamp()
  });

  // reset withdraw_balance for this user to 0
  const wbRef = doc(db,"withdraw_balance", currentUser.uid);
  const wbSnap = await getDoc(wbRef);
  if(wbSnap.exists()){
    await updateDoc(wbRef, { balance: 0, updatedAt: serverTimestamp() });
  } else {
    await setDoc(wbRef, { name: currentUser.displayName || "Admin", balance: 0, updatedAt: serverTimestamp() });
  }

  Swal.fire("Berhasil","Penarikan dicatat dan saldo kamu diset 0.","success");
  await loadFinance();
};

// lihatDetailWithdraw (global)
window.lihatDetailWithdraw = async function(){
  const snap = await getDocs(query(collection(db,"withdraw_logs"), orderBy("createdAt","desc")));
  const rows = [];
  snap.forEach(d=>{
    const dt = d.data();
    const t = dt.createdAt && dt.createdAt.toDate ? dt.createdAt.toDate().toLocaleString("id-ID") : "-";
    rows.push(`${t} — ${dt.name || '-'} — ${formatRp(dt.amount)} (period: ${dt.periodKey || "-"})`);
  });
  if(rows.length===0) return Swal.fire("Riwayat Penarikan","Belum ada riwayat","info");
  Swal.fire({ title:"Riwayat Penarikan", html: `<pre style="text-align:left">${rows.join("\n")}</pre>`, width:700 });
};

// lihatDetailKas (global)
window.lihatDetailKas = async function(){
  const snap = await getDocs(query(collection(db,"cash_history"), orderBy("createdAt","desc")));
  const rows = [];
  snap.forEach(d=>{
    const dt = d.data();
    const t = dt.createdAt && dt.createdAt.toDate ? dt.createdAt.toDate().toLocaleString("id-ID") : "-";
    rows.push(`${t} — ${formatRp(dt.amount)} (prev: ${formatRp(dt.prevAmount||0)})`);
  });
  if(rows.length===0) return Swal.fire("Riwayat Kas","Belum ada riwayat kas","info");
  Swal.fire({ title:"Riwayat Kas", html: `<pre style="text-align:left">${rows.join("\n")}</pre>`, width:700 });
};

// helper formatRp (global)
function formatRp(n){ return "Rp" + Number(n||0).toLocaleString("id-ID"); }

// ===== MAIN loadFinance (global) =====
window.loadFinance = async function(){
  const list = document.getElementById("financeList");
  financeSummaryEl.innerHTML = "";
  saldoBoxesEl.innerHTML = "";
  list.innerHTML = "<p class='text-gray-400 text-sm'>Memuat data...</p>";

  try{
    // load current finance_reports
    const snap = await getDocs(query(collection(db,"finance_reports"), orderBy("createdAt","desc")));
    const arr = [];
    snap.forEach(d=> arr.push({ id:d.id, ...d.data() }));
    // calculate totals
    let totalPemasukan = 0;
    let totalPengeluaran = 0;
    arr.forEach(it=>{
      if(it.jenis === 'pemasukan') totalPemasukan += Number(it.nominal || 0);
      if(it.jenis === 'pengeluaran') totalPengeluaran += Number(it.nominal || 0);
    });
    const laba = totalPemasukan - totalPengeluaran;
    const perAdminAmount = Math.floor(laba * 0.35);
    const saldoKasAmount = Math.floor(laba * 0.30);

    // check archive/reset logic: if today is 11 or 29 and not archived for this period, archive then clear
    const today = new Date();
    const day = today.getDate();
    const periodKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${day}`;
    if(day === 11 || day === 29){
      const alreadyArchived = await archiveExists(periodKey);
      if(!alreadyArchived && arr.length > 0){
        // archive each report doc into finance_archive with periodKey
        for(const item of arr){
          await addDoc(collection(db,"finance_archive"), { ...item, archivedAt: serverTimestamp(), periodKey });
          // delete original
          await deleteDoc(doc(db,"finance_reports", item.id));
        }
        // after archiving, optionally set some flags / keep finance_reports empty
        Swal.fire("Arsip Tersimpan","Transaksi periode ini telah diarsipkan.","success");
      }
      // After archiving, we still keep perAdminAmount & saldoKasAmount based on the just-archived laba
    }

    // update withdraw_balance for all existing admin docs to perAdminAmount (or create for current user)
    await updateAllWithdrawBalances(perAdminAmount);

    // update finance_meta saldo_kas (and write cash_history if changed)
    await updateFinanceMetaKas(saldoKasAmount);

    // render saldo boxes (per-admin amount displayed to current user is the perAdminAmount)
    renderSaldoBoxesUI(perAdminAmount, saldoKasAmount);

    // render summary cards
    renderFinanceSummary(totalPemasukan, totalPengeluaran);

    // render list
    if(arr.length === 0){
      list.innerHTML = "<p class='text-gray-400 text-sm'>Belum ada laporan.</p>";
      return;
    }
    list.innerHTML = "";
    arr.forEach(item=>{
      const t = item.createdAt && item.createdAt.toDate ? item.createdAt.toDate() : new Date();
      const waktu = t.toLocaleDateString("id-ID", {day:"2-digit", month:"short", year:"numeric"}) + " " + t.toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"});
      const div = document.createElement("div");
      div.className = "list-item flex justify-between items-start";
      div.innerHTML = `
        <div>
          <p class="font-semibold ${item.jenis==='pemasukan'?'text-green-400':'text-red-400'}">${item.jenis.toUpperCase()}</p>
          <p>Rp${Number(item.nominal).toLocaleString("id-ID")}</p>
          <p class="small-txt">${item.keterangan || '-'}</p>
          <p class="small-txt">🕒 Ditambahkan: ${waktu}</p>
          <p class="small-txt">Dibuat oleh: ${item.createdBy || '-'}</p>
        </div>
        <div class="flex flex-col gap-1">
          <button onclick="editTransaksi('${item.id}','${item.jenis}',${item.nominal},'${(item.keterangan||'').replace(/'/g,"\\'")}')" class="px-2 py-1 bg-yellow-500 hover:bg-yellow-600 rounded text-xs">✏️ Edit</button>
          <button onclick="hapusTransaksi('${item.id}')" class="px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">🗑️ Hapus</button>
        </div>
      `;
      list.appendChild(div);
    });

  } catch(e){
    console.error("loadFinance err:", e);
    document.getElementById("financeList").innerHTML = `<p class="text-red-400 text-sm">Gagal memuat laporan.</p>`;
  }
};

// render finance summary (global)
window.renderFinanceSummary = function(totalPemasukan, totalPengeluaran){
  const diff = totalPemasukan - totalPengeluaran;
  let percent = 0;
  if(totalPemasukan === 0){
    percent = totalPengeluaran === 0 ? 0 : -100;
  } else {
    percent = (diff / totalPemasukan) * 100;
  }
  const formatRp = (n) => "Rp" + Number(n).toLocaleString("id-ID");
  const formatPercent = (p) => {
    const sign = p > 0 ? "+" : (p < 0 ? "" : "");
    return sign + Number(p).toFixed(2) + "%";
  };

  financeSummaryEl.innerHTML = `
    <div class="p-3 rounded-lg bg-green-700/30 border border-green-600">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs text-gray-200">Total Pemasukan</p>
          <p class="text-lg font-bold">${formatRp(totalPemasukan)}</p>
        </div>
        <div class="text-2xl">💚</div>
      </div>
    </div>
    <div class="p-3 rounded-lg bg-red-700/30 border border-red-600">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs text-gray-200">Total Pengeluaran</p>
          <p class="text-lg font-bold">${formatRp(totalPengeluaran)}</p>
        </div>
        <div class="text-2xl">🔻</div>
      </div>
    </div>
    <div class="p-3 rounded-lg bg-blue-700/30 border border-blue-600">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs text-gray-200">Selisih (P/L)</p>
          <p class="text-lg font-bold">${formatRp(diff)}</p>
        </div>
        <div class="text-2xl">⚖️</div>
      </div>
    </div>
    <div class="p-3 rounded-lg bg-purple-700/30 border border-purple-600">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs text-gray-200">Persentase P&L</p>
          <p class="text-lg font-bold">${formatPercent(percent)}</p>
        </div>
        <div class="text-2xl">📈</div>
      </div>
    </div>
  `;
};

// CRUD finance functions (exposed)
window.tambahTransaksi = async ()=>{
  const jenis=document.getElementById("jenisTransaksi").value;
  const nominal=parseInt(document.getElementById("nominalTransaksi").value);
  const keterangan=document.getElementById("keteranganTransaksi").value.trim();
  if(!nominal){ Swal.fire("Error","Nominal wajib diisi","error"); return; }
  await addDoc(collection(db,"finance_reports"),{
    jenis, nominal, keterangan, createdBy:currentUser.displayName||"Admin", createdAt:serverTimestamp()
  });
  Swal.fire("Berhasil","Transaksi ditambahkan","success");
  document.getElementById("nominalTransaksi").value="";
  document.getElementById("keteranganTransaksi").value="";
  await loadFinance();
};

window.editTransaksi = async (id,jenis,nominal,keterangan)=>{
  const { value: formValues } = await Swal.fire({
    title:"Edit Transaksi",
    html:`
      <select id="jenisEdit" class="swal2-input">
        <option value="pemasukan" ${jenis==='pemasukan'?'selected':''}>Pemasukan</option>
        <option value="pengeluaran" ${jenis==='pengeluaran'?'selected':''}>Pengeluaran</option>
      </select>
      <input id="nominalEdit" type="number" class="swal2-input" value="${nominal}">
      <input id="ketEdit" type="text" class="swal2-input" value="${keterangan || ''}">
    `,
    focusConfirm:false,
    preConfirm:()=>[
      document.getElementById("jenisEdit").value,
      document.getElementById("nominalEdit").value,
      document.getElementById("ketEdit").value
    ]
  });
  if(!formValues) return;
  const [j,n,k]=formValues;
  await updateDoc(doc(db,"finance_reports",id),{
    jenis:j, nominal:parseInt(n), keterangan:k
  });
  Swal.fire("Disimpan","Transaksi diperbarui","success");
  await loadFinance();
};

window.hapusTransaksi = async (id)=>{
  const res = await Swal.fire({title:"Hapus transaksi ini?",icon:"warning",showCancelButton:true});
  if(!res.isConfirmed) return;
  await deleteDoc(doc(db,"finance_reports",id));
  Swal.fire("Dihapus","Data berhasil dihapus","success");
  await loadFinance();
};

// expose helpers to window (so inline onclick works)
window.renderSaldoBoxesUI = renderSaldoBoxesUI;
window.lihatDetailWithdraw = window.lihatDetailWithdraw;
window.lihatDetailKas = window.lihatDetailKas;
window.handleWithdraw = window.handleWithdraw;

// initial UI
renderDashboard();

</script>
</body>
</html>


