<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Crave Street Admin</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
  .list-item { background: rgba(55,65,81,0.5); border-radius: 12px; padding: 12px; }
  .small-txt { font-size: 12px; color: #c7c7c7; }
  @media print {
    body * { visibility: hidden; }
    #printArea, #printArea * { visibility: visible; }
    #printArea { position: absolute; top:0; left:0; width:100%; }
  }
</style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-black min-h-screen text-white">

<header class="sticky top-0 bg-gray-800/90 backdrop-blur-lg z-50 px-4 py-3 flex flex-wrap items-center justify-between shadow-lg">
  <div class="flex items-center gap-2 flex-1">
    <img src="https://vlcrave.github.io/admin/logo.png" alt="Logo" class="h-8 w-8 rounded-full">
    <h1 class="text-white font-bold text-lg truncate">Crave Street</h1>
  </div>
  <div class="flex items-center gap-3">
    <div class="text-right mr-2">
      <p class="text-gray-300 text-xs">Halo, <span id="userName" class="font-semibold text-blue-400">Admin</span></p>
      <p class="text-gray-400 text-[10px]">Role: <span id="userRole" class="font-semibold text-yellow-400">Admin</span></p>
    </div>
    <img id="userPhoto" src="https://vlcrave.github.io/admin/logo.png" alt="User Photo" class="h-8 w-8 rounded-full border-2 border-blue-400">
    <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded-lg font-semibold text-white text-xs">Logout</button>
  </div>
</header>

<main class="p-4 max-w-3xl mx-auto mt-6">

  <div id="dashboardGrid" class="space-y-4"></div>

  <!-- ================= VOUCHER CONTAINER ================= -->
  <div id="voucherContainer" class="hidden mt-6 text-white">
    <button onclick="backToDashboard()" class="mb-3 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded-lg">← Kembali ke Dashboard</button>
    <h2 class="text-xl font-bold mb-3">🎟️ Kelola Voucher</h2>

    <div class="bg-gray-800/60 p-4 rounded-xl mb-3">
      <label class="block text-sm font-semibold mb-2">Jumlah Generate (1 - 100)</label>
      <input id="voucherJumlah" type="number" min="1" max="100" placeholder="Masukkan jumlah" class="w-full px-3 py-2 rounded-lg bg-gray-700 text-white mb-3 focus:outline-none">
      <div class="flex gap-2">
        <button id="genBtn" onclick="generateVouchers()" class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-lg font-semibold">➕ Generate</button>
        <button onclick="loadVouchers()" class="bg-gray-600 hover:bg-gray-700 px-3 py-2 rounded-lg">🔄 Refresh</button>
        <button onclick="printAllVouchers()" class="bg-purple-600 hover:bg-purple-700 px-3 py-2 rounded-lg">🖨️ Print Semua</button>
      </div>
    </div>

    <div class="mb-2 flex gap-2">
      <button onclick="renderVouchers('all')" class="bg-gray-700 px-3 py-1 rounded-lg">Semua</button>
      <button onclick="renderVouchers('unused')" class="bg-gray-700 px-3 py-1 rounded-lg">Belum Dipakai</button>
      <button onclick="renderVouchers('used')" class="bg-gray-700 px-3 py-1 rounded-lg">Sudah Dipakai</button>
    </div>

    <div id="voucherList" class="space-y-3 max-h-96 overflow-y-auto pb-6"></div>
  </div>

  <!-- ================= FINANCE CONTAINER ================= -->
  <div id="financeContainer" class="hidden mt-6 text-white">
    <button onclick="backToDashboard()" class="mb-3 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded-lg">← Kembali ke Dashboard</button>
    <h2 class="text-xl font-bold mb-3">📊 Laporan Keuangan</h2>

    <!-- Form Tambah -->
    <div class="bg-gray-800/60 p-4 rounded-xl mb-4">
      <h3 class="font-semibold mb-2">Tambah Transaksi</h3>
      <div class="grid grid-cols-2 gap-2">
        <select id="jenisTransaksi" class="bg-gray-700 rounded-lg p-2">
          <option value="pemasukan">Pemasukan</option>
          <option value="pengeluaran">Pengeluaran</option>
        </select>
        <input id="nominalTransaksi" type="number" placeholder="Nominal (Rp)" class="bg-gray-700 rounded-lg p-2">
      </div>
      <input id="keteranganTransaksi" type="text" placeholder="Keterangan" class="bg-gray-700 rounded-lg p-2 w-full mt-2">
      <button onclick="tambahTransaksi()" class="mt-3 bg-green-600 hover:bg-green-700 px-3 py-2 rounded-lg w-full font-semibold">➕ Simpan Transaksi</button>
    </div>

    <!-- Daftar Laporan -->
    <div id="financeList" class="space-y-3 max-h-96 overflow-y-auto"></div>
  </div>

  <div id="printArea" class="hidden"></div>

</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAzzr0ChjdVi7m4Ge-EFm3OK43ASujjZ40",
  authDomain: "crave-street-id.firebaseapp.com",
  projectId: "crave-street-id",
  storageBucket: "crave-street-id.firebasestorage.app",
  messagingSenderId: "221955592583",
  appId: "1:221955592583:web:43dc59d791e750095cc322",
  measurementId: "G-WCRQGLW47B"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let existingVouchers = [];

const voucherListEl = document.getElementById("voucherList");
const voucherContainer = document.getElementById("voucherContainer");

// ===== AUTH =====
onAuthStateChanged(auth, async (user) => {
  if(!user) return window.location.href="login.html";
  currentUser = user;
  document.getElementById("userName").innerText = user.displayName || "Admin";
  document.getElementById("userRole").innerText = "Admin";
  renderDashboard();
  await loadVouchers();
  await loadFinance();
});

window.logout = ()=>signOut(auth).then(()=>window.location.href="login.html");

// ===== DASHBOARD =====
function renderDashboard(){
  voucherContainer.classList.add("hidden");
  const grid = document.getElementById("dashboardGrid");
  grid.innerHTML = "";
  const modules = [
    {key:"voucher", title:"🎟️ Kelola Voucher", desc:"Generate & kelola voucher redeem."},
    {key:"finance", title:"📊 Laporan Keuangan", desc:"Catat pemasukan & pengeluaran bisnis."}
  ];
  modules.forEach(mod=>{
    const card = document.createElement("div");
    card.className="list-item flex flex-col gap-2";
    card.innerHTML=`
      <div class="flex justify-between items-start">
        <div>
          <h3 class="font-semibold">${mod.title}</h3>
          <p class="text-sm text-gray-300">${mod.desc}</p>
        </div>
      </div>
      <div class="flex gap-2">
        <button onclick="showSection('${mod.key}')" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded-lg font-semibold">Lihat Detail</button>
      </div>
    `;
    grid.appendChild(card);
  });
}

window.showSection = function(key){
  document.getElementById("dashboardGrid").classList.add("hidden");
  if(key==="voucher"){
    voucherContainer.classList.remove("hidden");
    renderVouchers("all");
  }
  if(key==="finance"){
    document.getElementById("financeContainer").classList.remove("hidden");
    loadFinance();
  }
};

window.backToDashboard = function(){
  voucherContainer.classList.add("hidden");
  document.getElementById("financeContainer").classList.add("hidden");
  document.getElementById("dashboardGrid").classList.remove("hidden");
};

// =======================
// ===== FINANCE PART ====
// =======================
window.loadFinance = async ()=>{
  const list = document.getElementById("financeList");
  list.innerHTML = "<p class='text-gray-400 text-sm'>Memuat data...</p>";
  const snap = await getDocs(query(collection(db,"finance_reports"), orderBy("createdAt","desc")));
  const arr = [];
  snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
  list.innerHTML = "";
  if(arr.length===0){ list.innerHTML="<p class='text-gray-400 text-sm'>Belum ada laporan.</p>"; return; }

  const formatDate = (ts) => {
    if(!ts) return "-";
    const date = ts.toDate ? ts.toDate() : new Date(ts);
    return date.toLocaleDateString("id-ID", { day:"2-digit", month:"long", year:"numeric" }) + " " +
           date.toLocaleTimeString("id-ID", { hour:"2-digit", minute:"2-digit" });
  };

  arr.forEach(item=>{
    const waktu = formatDate(item.createdAt);
    const div = document.createElement("div");
    div.className="list-item flex justify-between items-start";
    div.innerHTML=`
      <div>
        <p class="font-semibold ${item.jenis==='pemasukan'?'text-green-400':'text-red-400'}">${item.jenis.toUpperCase()}</p>
        <p>Rp${item.nominal.toLocaleString("id-ID")}</p>
        <p class="small-txt">${item.keterangan || '-'}</p>
        <p class="small-txt">🕒 ${waktu}</p>
        <p class="small-txt">Dibuat oleh: ${item.createdBy || '-'}</p>
      </div>
      <div class="flex flex-col gap-1">
        <button onclick="editTransaksi('${item.id}','${item.jenis}',${item.nominal},'${item.keterangan||''}')" class="px-2 py-1 bg-yellow-500 hover:bg-yellow-600 rounded text-xs">✏️ Edit</button>
        <button onclick="hapusTransaksi('${item.id}')" class="px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">🗑️ Hapus</button>
      </div>
    `;
    list.appendChild(div);
  });
};

window.tambahTransaksi = async ()=>{
  const jenis=document.getElementById("jenisTransaksi").value;
  const nominal=parseInt(document.getElementById("nominalTransaksi").value);
  const keterangan=document.getElementById("keteranganTransaksi").value.trim();
  if(!nominal){ Swal.fire("Error","Nominal wajib diisi","error"); return; }
  await addDoc(collection(db,"finance_reports"),{
    jenis, nominal, keterangan, createdBy:currentUser.displayName||"Admin", createdAt:serverTimestamp()
  });
  Swal.fire("Berhasil","Transaksi ditambahkan","success");
  document.getElementById("nominalTransaksi").value="";
  document.getElementById("keteranganTransaksi").value="";
  loadFinance();
};

window.editTransaksi = async (id,jenis,nominal,keterangan)=>{
  const { value: formValues } = await Swal.fire({
    title:"Edit Transaksi",
    html:`
      <select id="jenisEdit" class="swal2-input">
        <option value="pemasukan" ${jenis==='pemasukan'?'selected':''}>Pemasukan</option>
        <option value="pengeluaran" ${jenis==='pengeluaran'?'selected':''}>Pengeluaran</option>
      </select>
      <input id="nominalEdit" type="number" class="swal2-input" value="${nominal}">
      <input id="ketEdit" type="text" class="swal2-input" value="${keterangan}">
    `,
    focusConfirm:false,
    preConfirm:()=>[
      document.getElementById("jenisEdit").value,
      document.getElementById("nominalEdit").value,
      document.getElementById("ketEdit").value
    ]
  });
  if(!formValues) return;
  const [j,n,k]=formValues;
  await updateDoc(doc(db,"finance_reports",id),{
    jenis:j, nominal:parseInt(n), keterangan:k
  });
  Swal.fire("Disimpan","Transaksi diperbarui","success");
  loadFinance();
};

window.hapusTransaksi = async (id)=>{
  const res = await Swal.fire({title:"Hapus transaksi ini?",icon:"warning",showCancelButton:true});
  if(!res.isConfirmed) return;
  await deleteDoc(doc(db,"finance_reports",id));
  Swal.fire("Dihapus","Data berhasil dihapus","success");
  loadFinance();
};

</script>
</body>
</html>
