<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Redeem & Spin Wheel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    .wheel { width: 300px; height: 300px; border-radius: 50%; border: 6px solid #ddd; position: relative; margin: 0 auto; transition: 5s ease-out; }
    .label { position: absolute; top: 50%; left: 50%; transform-origin: center left; color: #fff; font-weight: bold; font-size: 12px; text-shadow: 1px 1px 2px #000; }
    .confetti { position: fixed; width: 10px; height: 10px; top: -10px; animation: fall 3s linear infinite; }
    @keyframes fall { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(100vh); opacity: 0; } }
    .step { display: inline-block; width: 25px; height: 25px; border-radius: 50%; background: #ccc; margin: 5px; color: #fff; text-align: center; line-height: 25px; font-weight: bold; }
    .active { background: #22c55e !important; }
    .hidden { display: none; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center px-4">
  <h1 class="text-2xl font-bold mb-6 text-yellow-400">üéÅ REDEEM & SPIN WHEEL</h1>

  <!-- Progress Step -->
  <div class="flex justify-center mb-6">
    <div class="step active">1</div>
    <div class="step">2</div>
    <div class="step">3</div>
    <div class="step">4</div>
  </div>

  <!-- Redeem Form -->
  <div id="redeemForm" class="space-y-4 text-center">
    <input id="redeemCode" placeholder="Masukkan kode redeem" class="p-2 text-black rounded w-64 text-center">
    <button id="redeemButton" class="bg-yellow-400 px-4 py-2 rounded text-black font-bold hover:bg-yellow-500">Lanjut</button>
  </div>

  <!-- User Form -->
  <div id="userForm" class="space-y-4 hidden text-center">
    <input id="redeemName" placeholder="Nama lengkap" class="p-2 text-black rounded w-64 text-center">
    <input id="redeemWA" placeholder="Nomor WhatsApp" class="p-2 text-black rounded w-64 text-center">
    <button id="userFormButton" class="bg-green-500 px-4 py-2 rounded text-white font-bold hover:bg-green-600">Lanjut</button>
  </div>

  <!-- Spinner -->
  <div id="spinnerContainer" class="hidden text-center">
    <div id="spinnerWheel" class="wheel"></div>
    <button id="spinButton" class="bg-yellow-500 text-black font-bold mt-6 px-6 py-2 rounded">üéØ PUTAR</button>
    <p id="rewardText" class="mt-4 text-lg font-semibold"></p>
  </div>

  <!-- Payment Form -->
  <div id="paymentForm" class="hidden space-y-4 text-center">
    <select id="paymentMethod" class="p-2 text-black rounded w-64 text-center">
      <option value="">Pilih Metode Pembayaran</option>
      <option value="Dana">Dana</option>
      <option value="OVO">OVO</option>
      <option value="Gopay">Gopay</option>
      <option value="Bank">Transfer Bank</option>
    </select>
    <input id="accountName" placeholder="Nama Akun" class="p-2 text-black rounded w-64 text-center">
    <input id="accountNumber" placeholder="Nomor Akun" class="p-2 text-black rounded w-64 text-center">
    <button id="claimButton" class="bg-blue-500 px-4 py-2 rounded text-white font-bold hover:bg-blue-600">Kirim Hadiah</button>
  </div>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, doc, updateDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAzzr0ChjdVi7m4Ge-EFm3OK43ASujjZ40",
      authDomain: "crave-street-id.firebaseapp.com",
      projectId: "crave-street-id",
      storageBucket: "crave-street-id.firebasestorage.app",
      messagingSenderId: "221955592583",
      appId: "1:221955592583:web:43dc59d791e750095cc322"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const TELEGRAM_BOT_TOKEN = '8012881635:AAEBqLZZz0jaA4Ek0GsvFkzuEXoknxiq8Rg';
    const TELEGRAM_CHAT_ID = '6046360096';

    let rewards = [];
    let segmentAngle = 0;
    let hasSpun = false;
    let currentReward = null;
    let currentCodeId = null;

    // Ambil reward dari Firestore
    async function loadRewards() {
      const snap = await getDocs(collection(db, "spin_rewards"));
      rewards = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))
        .filter(r => r.stock > 0);
      if (rewards.length === 0) {
        Swal.fire("‚ö†Ô∏è", "Belum ada hadiah tersedia di Firestore", "warning");
        return;
      }
      segmentAngle = 360 / rewards.length;
      drawWheel();
    }

    // Render roda
    function drawWheel() {
      const wheel = document.getElementById("spinnerWheel");
      wheel.innerHTML = "";
      let gradient = "";
      rewards.forEach((r, i) => {
        gradient += `${r.color} ${i * segmentAngle}deg ${(i + 1) * segmentAngle}deg, `;
      });
      wheel.style.background = `conic-gradient(${gradient.slice(0, -2)})`;

      rewards.forEach((r, i) => {
        const label = document.createElement("div");
        label.className = "label";
        label.innerText = r.name;
        const angle = i * segmentAngle + segmentAngle / 2;
        label.style.transform = `translate(-50%,-50%) rotate(${angle}deg) translateY(-100px) rotate(-${angle}deg)`;
        wheel.appendChild(label);
      });
    }

    await loadRewards();

    function updateSteps(step) {
      document.querySelectorAll('.step').forEach((el, i) => el.classList.toggle('active', i < step));
    }

    function createConfetti() {
      for (let i = 0; i < 30; i++) {
        const c = document.createElement('div');
        c.className = 'confetti';
        c.style.left = Math.random() * 100 + '%';
        c.style.background = ['#fbbf24', '#f43f5e', '#22c55e', '#3b82f6'][Math.floor(Math.random() * 4)];
        document.body.appendChild(c);
        setTimeout(() => c.remove(), 3000);
      }
    }

    // REDEEM CODE
    document.getElementById("redeemButton").addEventListener("click", async () => {
      const code = document.getElementById("redeemCode").value.trim().toUpperCase();
      if (!code) return Swal.fire("‚ùå", "Masukkan kode redeem", "error");

      const q = query(collection(db, "redeem_codes"), where("code", "==", code));
      const snap = await getDocs(q);
      if (snap.empty) return Swal.fire("‚ùå", "Kode tidak valid", "error");

      const docData = snap.docs[0];
      if (docData.data().used) return Swal.fire("‚ö†Ô∏è", "Kode sudah digunakan", "warning");

      currentCodeId = docData.id;
      localStorage.setItem("redeemCode", code);
      updateSteps(2);
      document.getElementById("redeemForm").classList.add("hidden");
      document.getElementById("userForm").classList.remove("hidden");
    });

    // INPUT USER
    document.getElementById("userFormButton").addEventListener("click", async () => {
      const name = document.getElementById("redeemName").value.trim();
      const wa = document.getElementById("redeemWA").value.trim();
      if (!name || !wa) return Swal.fire("‚ùå", "Lengkapi data Anda", "error");

      await updateDoc(doc(db, "redeem_codes", currentCodeId), {
        used: true,
        usedBy: `${name} (${wa})`,
        used_at: serverTimestamp()
      });

      localStorage.setItem("redeemName", name);
      localStorage.setItem("redeemWA", wa);
      document.getElementById("userForm").classList.add("hidden");
      document.getElementById("spinnerContainer").classList.remove("hidden");
      updateSteps(3);
    });

    // SPIN LOGIC
    document.getElementById("spinButton").addEventListener("click", async () => {
      if (hasSpun) return;
      hasSpun = true;
      const wheel = document.getElementById("spinnerWheel");
      const rewardText = document.getElementById("rewardText");

      // Pilih berdasarkan chance
      const totalChance = rewards.reduce((sum, r) => sum + r.chance, 0);
      let pick = Math.random() * totalChance;
      let chosen = rewards[0];
      for (const r of rewards) {
        pick -= r.chance;
        if (pick <= 0) { chosen = r; break; }
      }

      const index = rewards.indexOf(chosen);
      const stopAngle = 360 * 5 + (360 - (index * segmentAngle + segmentAngle / 2));
      wheel.style.transform = `rotate(${stopAngle}deg)`;

      setTimeout(async () => {
        currentReward = chosen;
        rewardText.innerText = `üéâ Anda mendapatkan ${chosen.name}!`;
        createConfetti();

        // Kurangi stok
        await updateDoc(doc(db, "spin_rewards", chosen.id), { stock: chosen.stock - 1 });

        const name = localStorage.getItem("redeemName");
        const wa = localStorage.getItem("redeemWA");
        const code = localStorage.getItem("redeemCode");

        await addDoc(collection(db, "reward_claims"), {
          name, wa, code, reward: chosen.name, timestamp: serverTimestamp()
        });

        await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            chat_id: TELEGRAM_CHAT_ID,
            text: `üéØ *Klaim Hadiah Baru!*\nüéÅ ${chosen.name}\nüì± ${wa}\nüë§ ${name}\nüîë ${code}`,
            parse_mode: "Markdown"
          })
        });

        Swal.fire("üéä Selamat!", `Anda mendapat ${chosen.name}!`, "success");
        setTimeout(() => {
          document.getElementById("spinnerContainer").classList.add("hidden");
          document.getElementById("paymentForm").classList.remove("hidden");
          updateSteps(4);
        }, 2000);
        hasSpun = false;
      }, 5200);
    });

    // KLAIM PEMBAYARAN
    document.getElementById("claimButton").addEventListener("click", async () => {
      const method = document.getElementById("paymentMethod").value;
      const accName = document.getElementById("accountName").value.trim();
      const accNumber = document.getElementById("accountNumber").value.trim();
      if (!method || !accName || !accNumber) return Swal.fire("‚ö†Ô∏è", "Lengkapi data pembayaran", "error");

      const name = localStorage.getItem("redeemName");
      const wa = localStorage.getItem("redeemWA");
      const code = localStorage.getItem("redeemCode");

      await addDoc(collection(db, "payment_claims"), {
        name, wa, code, reward: currentReward.name,
        paymentMethod: method, accountName: accName, accountNumber: accNumber,
        timestamp: serverTimestamp()
      });

      Swal.fire("‚úÖ Berhasil!", "Hadiah akan dikirim dalam 1x24 jam.", "success").then(() => {
        localStorage.clear();
        location.reload();
      });
    });
  </script>
</body>
</html>
