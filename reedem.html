<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redeem Code - Crave Street</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* Spinner Wheel CSS */
        #spinnerWheel {
            transition: transform 3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        /* Segmen Spinner (5 bagian lingkaran) */
        .segment {
            position: absolute;
            border-radius: 50% 50% 50% 50% / 100% 100% 0 0;
            transform-origin: 50% 100%;
            left: 50%;
            top: 50%;
            width: 100%;
            height: 100%;
            margin-left: -50%;
            margin-top: -50%;
        }
        
        .segment-1 { /* ZONK: 144¬∞ (58%) */
            background: #ef4444;
            transform: rotate(0deg);
            clip-path: polygon(0 0, 100% 0, 100% 40%);
        }
        
        .segment-2 { /* 2K: 36¬∞ (10%) */
            background: #10b981;
            transform: rotate(144deg);
            clip-path: polygon(0 0, 100% 0, 100% 10%);
        }
        
        .segment-3 { /* 10K: 7.2¬∞ (2%) */
            background: #059669;
            transform: rotate(180deg);
            clip-path: polygon(0 0, 100% 0, 100% 2%);
        }
        
        .segment-4 { /* 20K: 0¬∞ (placeholder 36¬∞) */
            background: #3b82f6;
            transform: rotate(187.2deg);
            clip-path: polygon(0 0, 100% 0, 100% 0%); /* Kosong */
        }
        
        .segment-5 { /* +1 TRY: 108¬∞ (30%) */
            background: #f59e0b;
            transform: rotate(194.4deg);
            clip-path: polygon(0 0, 100% 0, 100% 30%);
        }
        
        /* Pointer (panah) */
        .pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 20px solid #fff;
            z-index: 10;
        }
        
        /* Label Segmen (sederhana) */
        .label {
            position: absolute;
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            transform-origin: center;
        }
        
        .label-1 { top: 20%; left: 45%; transform: rotate(0deg); }
        .label-2 { top: 10%; right: 20%; transform: rotate(72deg); }
        .label-3 { top: 5%; right: 40%; transform: rotate(144deg); }
        .label-4 { bottom: 10%; right: 20%; transform: rotate(216deg); }
        .label-5 { bottom: 20%; left: 40%; transform: rotate(288deg); }
        
        /* Responsive */
        @media (max-width: 640px) {
            .label { font-size: 10px; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 max-w-md w-full shadow-2xl border border-white/20">
        <h1 class="text-3xl font-bold text-center text-white mb-6">üéÅ Redeem Code</h1>
        
        <div id="redeemForm" class="space-y-4">
            <input 
                type="text" 
                id="redeemCode" 
                placeholder="Masukkan kode redeem" 
                class="w-full px-4 py-3 bg-white/20 rounded-lg text-white placeholder-gray-300 border border-white/30 focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-400"
                maxlength="10"
            >
            <button 
                onclick="redeemCode()" 
                class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold transition duration-200"
            >
                Redeem
            </button>
        </div>

        <!-- Spinner Container (hidden awalnya) -->
        <div id="spinnerContainer" class="hidden mt-6">
            <h2 class="text-xl font-bold text-center text-white mb-4">Memutar Hadiah...</h2>
            <div class="relative w-64 h-64 mx-auto">
                <!-- Spinner Wheel -->
                <div id="spinnerWheel" class="w-full h-full border-4 border-white/30 rounded-full overflow-hidden relative">
                    <!-- Segmen 1: ZONK (merah, 58%) -->
                    <div class="segment segment-1"></div>
                    <!-- Segmen 2: 2K (hijau muda, 10%) -->
                    <div class="segment segment-2"></div>
                    <!-- Segmen 3: 10K (hijau tua, 2%) -->
                    <div class="segment segment-3"></div>
                    <!-- Segmen 4: 20K (biru, 0%) -->
                    <div class="segment segment-4"></div>
                    <!-- Segmen 5: +1 PERCOBAAN (kuning, 30%) -->
                    <div class="segment segment-5"></div>
                    
                    <!-- Pointer (panah atas) -->
                    <div class="pointer"></div>
                    
                    <!-- Label Segmen -->
                    <div class="label label-1">ZONK</div>
                    <div class="label label-2">2K</div>
                    <div class="label label-3">10K</div>
                    <div class="label label-4">20K</div>
                    <div class="label label-5">+1 TRY</div>
                </div>
            </div>
        </div>

        <p class="text-center text-gray-300 mt-4 text-sm">Pastikan kode redeem valid dan belum digunakan. Setelah redeem, masukkan nama lengkap dan nomor WhatsApp Anda.</p>
    </div>

    <!-- Firebase JS (Modular, tanpa Auth) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        // ===== FIREBASE CONFIG ===== (Sesuaikan dengan project Anda)
        const firebaseConfig = {
            apiKey: "AIzaSyAzzr0ChjdVi7m4Ge-EFm3OK43ASujjZ40",
            authDomain: "crave-street-id.firebaseapp.com",
            projectId: "crave-street-id",
            storageBucket: "crave-street-id.firebasestorage.app",
            messagingSenderId: "221955592583",
            appId: "1:221955592583:web:43dc59d791e750095cc322",
            measurementId: "G-WCRQGLW47B"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ===== REDEEM FUNCTION =====
        window.redeemCode = async () => {
            const codeInput = document.getElementById('redeemCode');
            const code = codeInput.value.trim().toUpperCase();

            if (!code) {
                Swal.fire('Error', 'Masukkan kode redeem!', 'error');
                return;
            }

            // Verifikasi kode dari Firebase
            try {
                const q = query(collection(db, 'redeem_codes'), where('code', '==', code), where('used', '==', false));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    Swal.fire('Gagal', 'Kode redeem tidak valid atau sudah digunakan!', 'error');
                    return;
                }

                // Ambil dokumen pertama (asumsi kode unik)
                const redeemDoc = querySnapshot.docs[0];

                // Tampilkan Swal untuk input nama dan nomor WA
                const { value: userData } = await Swal.fire({
                    title: 'Data Pribadi',
                    text: 'Masukkan nama lengkap dan nomor WhatsApp Anda untuk memproses redeem.',
                    html: `
                        <input id="swalName" class="swal2-input" placeholder="Nama Lengkap" style="margin-bottom: 10px;">
                        <input id="swalWhatsapp" type="number" class="swal2-input" placeholder="Nomor WhatsApp (contoh: 08123456789)">
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'Lanjutkan',
                    cancelButtonText: 'Batal',
                    preConfirm: () => {
                        const name = document.getElementById('swalName').value.trim();
                        const whatsapp = document.getElementById('swalWhatsapp').value.trim();

                        if (!name) {
                            Swal.showValidationMessage('Nama lengkap harus diisi!');
                            return false;
                        }
                        if (!whatsapp || whatsapp.length < 10) {
                            Swal.showValidationMessage('Nomor WhatsApp harus valid (minimal 10 digit)!');
                            return false;
                        }
                        return { name, whatsapp };
                    }
                });

                if (!userData) {
                    Swal.fire('Dibatalkan', 'Proses redeem dibatalkan.', 'info');
                    return;
                }

                // Update dokumen: tandai sebagai used + simpan data user
                await updateDoc(doc(db, 'redeem_codes', redeemDoc.id), {
                    used: true,
                    userName: userData.name,
                    whatsappNumber: userData.whatsapp,
                    redeemTime: serverTimestamp()
                });

                // Clear input kode
                codeInput.value = '';

                // Tampilkan Swal konfirmasi data
                Swal.fire({
                    title: 'Data Terkonfirmasi',
                    text: `Terima kasih, ${userData.name}! Nomor WA: ${userData.whatsapp}. Memproses hadiah...`,
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });

                // Tampilkan spinner
                showSpinner();

                // Simulate proses (delay untuk animasi spinner)
                setTimeout(() => {
                    const result = generateRandomResult();
                    showResult(result, userData.name);
                }, 3000); // 3 detik

            } catch (error) {
                console.error('Error redeeming code:', error);
                Swal.fire('Error', 'Terjadi kesalahan. Coba lagi nanti.', 'error');
            }
        };

        // ===== SHOW SPINNER =====
        function showSpinner() {
            document.getElementById('redeemForm').classList.add('hidden');
            document.getElementById('spinnerContainer').classList.remove('hidden');

            const wheel = document.getElementById('spinnerWheel');
            // Reset dan animasi putaran random
            wheel.style.transition = 'none';
            wheel.style.transform = 'rotate(0deg)';
            wheel.offsetHeight; // Trigger reflow
            const randomRotation = Math.floor(Math.random() * 720) + 1080; // 3-5 putaran + random
            wheel.style.transition = 'transform 3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            wheel.style.transform = `rotate(${randomRotation}deg)`;
        }

        // ===== GENERATE RANDOM RESULT (Weighted Probability) =====
        function generateRandomResult() {
            const rand = Math.random() * 100;
            if (rand < 58) return 'ZONK'; // 58%
            else if (rand < 68) return '2K'; // 10%
            else if (rand < 70) return '10K'; // 2%
            else if (rand < 100) return '+1 PERCOBAAN'; // 30%
            else return '20K'; // 0% (jarang)
        }

        // ===== SHOW RESULT dengan Swal =====
        function showResult(result, userName) {
            const wheel = document.getElementById('spinnerWheel');
            wheel.style.transition = 'none'; // Stop animasi

            let title = result;
            let text = '';
            let icon = 'info';
            let confirmButtonColor = '#3b82f6';

            switch (result) {
                case 'ZONK':
                    text = `Sayang sekali, ${userName}! Kamu dapat ZONK. Coba lagi lain kali!`;
                    icon = 'error';
                    break;
                case '2K':
                    text = `Selamat, ${userName}! Kamu dapat Rp 2.000. Saldo akan ditambahkan ke akun WhatsApp-mu.`;
                    icon = 'success';
                    break;
                case '10K':
                    text = `Wah, ${userName}! Kamu dapat Rp 10.000. Saldo akan ditambahkan ke akun WhatsApp-mu.`;
                    icon = 'success';
                    break;
                case '20K':
                    text = `Jackpot, ${userName}! Kamu dapat Rp 20.000. Saldo akan ditambahkan ke akun WhatsApp-mu.`;
                    icon = 'success';
                    break;
                case '+1 PERCOBAAN':
                    text = `Bagus, ${userName}! Kamu dapat +1 percobaan ekstra. Gunakan segera!`;
                    icon = 'success';
                    break;
            }

            // Hide spinner dan tampilkan hasil dengan Swal
            document.getElementById('spinnerContainer').classList.add('hidden');
            document.getElementById('redeemForm').classList.remove('hidden');

            Swal.fire({
                title: title,
                text: text,
                icon: icon,
                confirmButtonText: 'OK',
                confirmButtonColor: confirmButtonColor
            });
        }

        // ===== Event Listener untuk Enter Key (pada input kode) =====
        document.addEventListener('DOMContentLoaded', () => {
            const codeInput = document.getElementById('redeemCode');
            codeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    redeemCode();
                }
            });
        });
    </script>
</body>
</html>
